<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LLDB Song Helper">
    <meta name="application-name" content="LLDB Song Helper">
    
    <link rel="apple-touch-icon" href="https://unavatar.io/twitter/noki_dochibi">
    <link rel="icon" href="https://unavatar.io/twitter/noki_dochibi">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-0D09G3X4F1');
    </script>

    <title>LLDB Song Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. Base & Theme Colors
           ========================================= */
        :root {
            --bg-color: #F8F9FA;
            --main-orange: #F4A261;
            --main-pink: #ec4899;
            --bubble-color: #F4A261; /* JSã§å‹•çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ */
            --nav-height: 85px;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease; 
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .send-btn-active:active { transform: scale(0.9); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .message-row { scroll-margin-top: 6rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        .highlight-text {
            color: #ea580c;
            font-weight: bold;
            background-color: #fff7ed;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* å¹ãå‡ºã— (Default) */
        .bubble { position: relative; border-radius: 1.2rem; transition: background-color 0.3s, color 0.3s; }
        
        /* å³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰å´ã®ã—ã£ã½ï¼švar(--bubble-color)ã‚’ä½¿ç”¨ */
        .bubble-right::before {
            content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent var(--bubble-color);
        }
        
        /* å·¦ï¼ˆBotï¼‰å´ã®ã—ã£ã½ */
        .bubble-left::before {
            content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent;
        }

        /* =========================================
           2. Footer & Tabs (Unified 85px Height)
           ========================================= */
        footer {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 30;
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #search-form {
            padding: 10px 14px;
            background-color: rgba(255,255,255,0.98);
            border-bottom: 1px solid #f3f4f6;
        }

        /* è‡ªå‹•ãƒªã‚µã‚¤ã‚ºç”¨ textarea (LINEé¢¨) */
        textarea#search-input {
            resize: none; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ãƒªã‚µã‚¤ã‚ºç„¡åŠ¹ */
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éš ã™ */
            min-height: 24px; /* 1è¡Œåˆ†ã®é«˜ã•ç¢ºä¿ */
            max-height: 120px; /* æœ€å¤§5è¡Œç¨‹åº¦ã§æ­¢ã‚ã‚‹ */
            line-height: 1.5;
            padding-top: 8px;   /* ä¸Šä¸‹ä¸­å¤®å¯„ã›èª¿æ•´ */
            padding-bottom: 8px;
        }
        /* ãƒ†ã‚­ã‚¹ãƒˆãŒå¢—ãˆã¦max-heightã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ */
        textarea#search-input:focus {
            overflow-y: auto;
        }

        #footer-tab-area {
            display: flex;
            width: 100%;
            background-color: white;
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 12px;
            gap: 4px;
            color: #94a3b8;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
        }

        .tab-btn.active {
            font-weight: bold;
            color: var(--main-orange);
        }
        /* ã—ã‚Šã¨ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼ˆè£ãƒ¢ãƒ¼ãƒ‰ï¼‰ã®ã¨ãã¯ãƒ”ãƒ³ã‚¯ */
        body.theme-shiritori .tab-btn.active {
            color: var(--main-pink);
        }
        
        .tab-btn.active svg {
            stroke-width: 2.5px;
        }

        /* 3. Request UI */
        .letter-card {
            background: white;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .letter-q {
            background-color: #fffaf5;
            padding: 16px;
            border-bottom: 1px dashed #fed7aa;
        }
        .letter-a {
            padding: 16px;
            background-color: white;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ (Secret) */
        body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
        body.dark-mode footer { background-color: #1e293b; border-color: #334155; }
        body.dark-mode #search-form { background-color: #1e293b; border-bottom-color: #334155; }
        body.dark-mode .bubble-left { background-color: #334155; color: #f1f5f9; }
        body.dark-mode .bubble-left::before { border-color: transparent #334155 transparent transparent; }
        body.dark-mode .letter-card { background-color: #1e293b; border-color: #334155; }
        body.dark-mode .letter-q { background-color: #334155; border-bottom-color: #475569; }
        body.dark-mode .bg-gray-100 { background-color: #334155; }

        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
    </style>
</head>
<body id="app-body" class="theme-lyrics h-screen flex flex-col transition-colors duration-300">

    <!-- 1. æ­Œè©(ãƒ•ãƒ¬ãƒ¼ã‚º)ãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-lyrics" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼
                </p>
            </div>
        </div>
    </main>

    <!-- 2. æ¥½æ›²DBãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-title" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚„åéŒ²æ›²é †ã‚’æ•™ãˆã‚‹ã‚ˆğŸ’¿
                </p>
            </div>
        </div>
    </main>

    <!-- 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (èª¿æŸ»ãƒ»æ”¹å–„) -->
    <main id="chat-container-request" class="flex-1 overflow-y-auto p-4 no-scrollbar pb-48 hidden">
        <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <span class="text-2xl">ğŸ“‹</span> ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            </h2>
            <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 mt-3 flex items-start gap-2">
                <i data-lucide="shield-check" class="w-4 h-4 text-orange-500 mt-0.5 flex-shrink-0"></i>
                <p class="text-[11px] text-orange-700 leading-relaxed">
                    Song HelperãŒã‚ãªãŸã®èª¿æŸ»ä¾é ¼ã‚„æ”¹å–„è¦æœ›ã«ãŠç­”ãˆã—ã¾ã™ã€‚æ¥½ã—ãä½¿ã£ã¦ã„ãŸã ããŸã‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ²è¼‰ã—ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ğŸŒ¸
                </p>
            </div>
        </div>
        
        <div id="request-list" class="space-y-4">
            <div class="text-center py-10 text-gray-400 text-xs animate-pulse" id="request-loading">
                ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    </main>

    <!-- 4. ã—ã‚Šã¨ã‚Šãƒãƒ£ãƒƒãƒˆ (Secret) -->
    <main id="chat-container-shiritori" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">ã•ãã€ã—ã‚Šã¨ã‚Šã®æ™‚é–“ã ã€‚æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã¿ã‚ˆã€‚</p>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer>
        <form id="search-form">
            <!-- å…¥åŠ›æ¬„ã‚³ãƒ³ãƒ†ãƒŠ: flex items-end ã§ä¸‹æƒãˆ (è¤‡æ•°è¡Œå¯¾å¿œ) -->
            <div class="relative flex items-end w-full bg-gray-100 rounded-[24px] px-4 py-1 focus-within:bg-white focus-within:ring-1 focus-within:ring-orange-200 border border-transparent focus-within:border-orange-300 transition-all shadow-inner">
                <!-- textarea: rows=1ã§åˆæœŸåŒ– -->
                <textarea id="search-input" rows="1"
                    class="flex-1 bg-transparent border-none focus:outline-none text-[15px] placeholder-gray-400 min-w-0"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off"></textarea>
                
                <!-- é€ä¿¡ãƒœã‚¿ãƒ³: mb-2 ã§ä½ç½®èª¿æ•´ -->
                <button type="submit" id="submit-btn"
                    class="send-btn-active ml-2 text-orange-500 p-1.5 rounded-full hover:bg-orange-100 transition-colors flex-shrink-0 mb-1.5">
                    <i data-lucide="send" class="w-5 h-5 fill-current"></i>
                </button>
            </div>
        </form>

        <div id="footer-tab-area">
            <button id="tab-lyrics" data-tab="lyrics" onclick="switchTab('lyrics')" class="tab-btn active">
                <i data-lucide="music" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒ•ãƒ¬ãƒ¼ã‚º</span>
            </button>
            <div class="w-[1px] bg-gray-50 my-3"></div>
            <button id="tab-title" data-tab="title" onclick="switchTab('title')" class="tab-btn">
                <i data-lucide="disc" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">æ¥½æ›²</span>
            </button>
            <div class="w-[1px] bg-gray-50 my-3"></div>
            <button id="tab-request" data-tab="request" onclick="switchTab('request')" class="tab-btn">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
            </button>
        </div>
    </footer>

    <!-- About Modal -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4 border-b border-gray-50 pb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-500 p-1.5 rounded-lg">ğŸŒ·</span>
                    About App
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1 bg-gray-50 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-6 text-sm text-gray-600 leading-relaxed overflow-y-auto max-h-[60vh] px-1 pb-2 no-scrollbar">
                <div class="text-center mb-2">
                    <p class="text-[10px] font-bold text-orange-400 tracking-widest mb-1">WELCOME</p>
                    <p class="text-gray-700 font-medium">ãŠèŠ±ã¡ã‚ƒã‚“ã®ãŸã‚ã®<br>ãƒã‚±ãƒƒãƒˆè¾æ›¸ã§ã™ğŸŒ·</p>
                </div>
                <div class="space-y-4">
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="music" class="w-4 h-4"></i> ãƒ•ãƒ¬ãƒ¼ã‚ºã‹ã‚‰æ¢ã™</h3>
                        <p class="text-xs leading-5">èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®æ­Œè©ãŒå«ã¾ã‚Œã‚‹æ›²ã‚’æ¢ã—ã¾ã™ã€‚</p>
                    </div>
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="disc" class="w-4 h-4"></i> æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹</h3>
                        <p class="text-xs leading-5">æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‹ã‚‰ã€è©³ç´°ãªæƒ…å ±ã‚’æ•™ãˆã¾ã™ã€‚</p>
                    </div>
                    <div class="bg-gray-800 text-gray-300 p-4 rounded-xl border border-gray-700 relative overflow-hidden group shadow-md">
                        <h3 class="font-bold text-pink-400 flex items-center gap-2 mb-2 relative z-10"><i data-lucide="gamepad-2" class="w-4 h-4"></i> Secret Mode</h3>
                        <p class="text-xs leading-5 relative z-10"><span class="text-pink-300 font-bold">ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³</span>ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨...</p>
                    </div>
                </div>
                <div class="text-center pt-6 border-t border-gray-100">
                    <p class="text-[10px] text-gray-400 mb-2">Developed by @noki_dochibi</p>
                    <p class="text-[10px] text-gray-300 mt-4 font-mono tracking-wider">v2.3.1</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <script>
        const APP_VERSION = 'v2.3.1';
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec"; 
        const ICON_URL = `https://unavatar.io/twitter/noki_dochibi?v=${APP_VERSION}`;

        let currentMode = 'lyrics'; 
        let lastMode = 'lyrics'; 
        let isDarkMode = false; 

        const LOADING_MESSAGES = {
            lyrics: ["aikoã‹ã‚‰ã®telepathyã‚’å—ä¿¡ä¸­...", "ãã‚“ãªã“ã¨ã‚ˆã‚Šãƒ‘ãƒ¼ãƒ†ã‚£æŠœã‘å‡ºã•ãªã„ï¼Ÿ"],
            title: ["ãŠã£ï¼ãã®æ›²ãªã‚‰ç¢ºã‹ã­...", "ä¿ºã‚‚ãã‚Œå¥½ãã ã‚ˆï¼å¾…ã£ã¦ã¦..."],
            shiritori: ["ä¿ºã«å‹è² ã‚’ä»•æ›ã‘ã‚‹ã¨ã¯ã„ã„åº¦èƒ¸ã ã€‚", "ãªã‚‹ã»ã©ã€ãã†æ¥ãŸã‹..."],
            request: ["ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ğŸ“®"]
        };

        const dom = {
            body: document.getElementById('app-body'),
            containers: {
                lyrics: document.getElementById('chat-container-lyrics'),
                title: document.getElementById('chat-container-title'),
                request: document.getElementById('chat-container-request'),
                shiritori: document.getElementById('chat-container-shiritori')
            },
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('readme-modal'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            botIcons: document.querySelectorAll('.bot-icon'),
            requestList: document.getElementById('request-list')
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            dom.botIcons.forEach(img => img.src = ICON_URL);
            fetchRequests(); 
            setupAutoResizeTextarea();
        });

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºè¨­å®š
        function setupAutoResizeTextarea() {
            const el = dom.searchInput;
            el.addEventListener('input', () => {
                el.style.height = 'auto'; // ä¸€æ—¦autoã«ã—ã¦ç¸®å°ã«å¯¾å¿œ
                el.style.height = (el.scrollHeight) + 'px'; // å†…å®¹ã«åˆã‚ã›ã¦é«˜ã•ã‚’è¨­å®š
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetTextareaHeight() {
            const el = dom.searchInput;
            el.style.height = 'auto';
        }

        window.switchTab = function(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            dom.tabBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === mode);
            });

            Object.keys(dom.containers).forEach(key => {
                dom.containers[key].classList.toggle('hidden', key !== mode);
            });

            // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼(Bubble Color)ã®åˆ‡ã‚Šæ›¿ãˆ
            if (mode === 'shiritori') {
                document.documentElement.style.setProperty('--bubble-color', '#ec4899'); // Pink
            } else {
                document.documentElement.style.setProperty('--bubble-color', '#F4A261'); // Orange
            }

            if (mode === 'lyrics') {
                dom.searchInput.placeholder = "ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«";
            } else if (mode === 'title') {
                dom.searchInput.placeholder = "ä¾‹ï¼šãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«";
            } else if (mode === 'request') {
                dom.searchInput.placeholder = "èª¿æŸ»ã‚„æ”¹å–„ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã­ğŸ“®";
                fetchRequests();
            } else if (mode === 'shiritori') {
                dom.searchInput.placeholder = "æ›²åã‚’å…¥åŠ›ã—ã¦ã­";
            }
            
            const activeContainer = dom.containers[mode];
            activeContainer.scrollTop = activeContainer.scrollHeight;
        };

        window.activateSecretMode = function() {
            if (currentMode === 'shiritori') {
                isDarkMode = false;
                dom.body.classList.remove('dark-mode');
                dom.body.classList.remove('theme-shiritori');
                dom.body.classList.add('theme-lyrics');
                switchTab(lastMode);
            } else {
                lastMode = currentMode;
                isDarkMode = true;
                dom.body.classList.add('dark-mode');
                dom.body.classList.remove('theme-lyrics');
                dom.body.classList.add('theme-shiritori');
                switchTab('shiritori');
            }
        };

        dom.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = dom.searchInput.value.trim();
            if (!query) return;

            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (currentMode === 'request') {
                if (!confirm("ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚ã—ãªã„
                }
                handleRequestPost(query);
                dom.searchInput.value = '';
                resetTextareaHeight(); 
                return;
            }

            addMessage(query, 'user');
            dom.searchInput.value = '';
            resetTextareaHeight(); 
            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'success') {
                    if (currentMode === 'lyrics') handleLyricsResults(data);
                    else if (currentMode === 'title') handleTitleResults(data);
                    else handleShiritoriResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„...", 'bot');
                }
            } catch (error) {
                removeLoading(loadingId);
                addMessage("é€šä¿¡å¤±æ•—ï¼ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        async function handleRequestPost(query) {
            const card = document.createElement('div');
            card.className = "letter-card animate-fade-in border-dashed bg-orange-50/20";
            card.innerHTML = `
                <div class="letter-q bg-transparent border-none">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">ç¢ºèªä¸­</span>
                        <span class="text-[10px] text-gray-400">ãŸã ã„ã¾</span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed font-bold">${query.replace(/\n/g, '<br>')}</p>
                    <p class="text-[10px] text-gray-400 mt-2 italic">â€»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ãŸå¾Œã«å…¨ä½“ã¸å…¬é–‹ã•ã‚Œã¾ã™ğŸŒ¸</p>
                </div>
            `;
            dom.requestList.insertBefore(card, dom.requestList.firstChild);
            showToast("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã‚ˆï¼ğŸ“®");

            try {
                await fetch(`${GAS_API_URL}?action=postRequest&q=${encodeURIComponent(query)}`);
            } catch(e) { console.error("Post failed", e); }
        }

        async function fetchRequests() {
            try {
                const res = await fetch(`${GAS_API_URL}?action=getRequests`);
                const json = await res.json();
                if (json.status === 'success') {
                    renderRequests(json.data);
                }
            } catch(e) { console.error("Fetch failed", e); }
        }

        function renderRequests(data) {
            if (data.length === 0) {
                dom.requestList.innerHTML = '<p class="text-center py-10 text-gray-400 text-xs">ã¾ã ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            dom.requestList.innerHTML = data.map(item => `
                <div class="letter-card animate-fade-in">
                    <div class="letter-q">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">æ²è¼‰ä¸­</span>
                            <span class="text-[10px] text-gray-400">${item.date}</span>
                        </div>
                        <p class="text-sm text-gray-700 leading-relaxed font-bold">${item.question.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="letter-a">
                        <div class="flex items-start gap-3">
                            <img src="${ICON_URL}" class="w-8 h-8 rounded-full border border-gray-100">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold text-gray-800">Song Helper</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    ${item.answer ? item.answer.replace(/\n/g, '<br>') : '<span class="text-gray-300 italic">å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„...ğŸŒ¸</span>'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function handleLyricsResults(data) {
            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­Œè©ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è¡¨è¨˜ã«ã—ã¦ã¿ã¦ï¼`, 'bot');
                return;
            }
            let html = '<div class="flex flex-col animate-fade-in">';
            if (data.fuzzy_type) {
                html += `<div class="bg-orange-100/50 border border-orange-200 rounded-lg p-2.5 mb-3 text-xs text-orange-700">
                    ã€Œ<span class="font-bold">${data.query}</span>ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©ã€<br>
                    ã€Œ<span class="font-bold text-orange-600">${data.actual_query}</span>ã€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆï¼ (${data.fuzzy_type})
                </div>`;
            }
            const highlightWord = data.fuzzy_type ? data.actual_query : data.query;
            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-gray-100' : '';
                const highlighted = item.phrase.replace(new RegExp(`(${highlightWord})`, 'gi'), '<span class="highlight-text">$1</span>');
                html += `<div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" class="${borderClass} py-3 cursor-pointer hover:bg-orange-50/30 transition select-none">
                    <p class="text-sm text-gray-700 leading-relaxed">${highlighted} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span></p>
                </div>`;
            });
            const uniqueSongs = new Set(data.results.map(item => item.title)).size;
            // å¾©å…ƒ: ãƒˆãƒƒãƒ—ã¸ç§»å‹•ãƒœã‚¿ãƒ³
            html += `<div class="mt-3 pt-2 border-t border-dashed border-orange-200">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] text-gray-400 font-bold">${uniqueSongs}æ›² / è¨ˆ${data.results.length}ç®‡æ‰€</p>
                    <button onclick="copyToClipboard('${data.results.map(r=>r.display_text).join('\\n').replace(/'/g,"\\'")}')" class="text-[10px] text-orange-500 bg-orange-50 px-2 py-1 rounded-full border border-orange-100">ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div class="flex justify-center">
                    <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button>
                </div>
            </div></div>`;
            addMessage(html, 'bot', true);
            lucide.createIcons();
        }

        function handleTitleResults(data) {
             if ((!data.songs || data.songs.length === 0) && (!data.albums || data.albums.length === 0)) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­£å¼åç§°ã§æ•™ãˆã¦ã­ï¼`, 'bot');
                return;
            }
            // å¾©å…ƒ: v2.3.1ã®ãƒªãƒƒãƒUI
            let html = '<div class="flex flex-col gap-4 animate-fade-in">';
            if (data.songs && data.songs.length > 0) {
                if (data.albums && data.albums.length > 0) html += '<div class="text-xs font-bold text-orange-500 border-b border-orange-100 pb-1">ğŸµ æ›²ã®æ¤œç´¢çµæœ</div>';
                data.songs.forEach((song, idx) => {
                    const hasDivider = idx > 0 ? 'border-t border-orange-100 pt-4' : '';
                    const ageText = song.age_at_release ? `ãƒªãƒªãƒ¼ã‚¹æ™‚ã®aikoã¯<span class="font-bold text-orange-600">${song.age_at_release}æ­³</span>ã ã‚ˆã€‚` : '';
                    const songLink = song.link_url ? `<a href="${song.link_url}" target="_blank" class="text-orange-600 underline font-bold hover:text-orange-400">${song.title}</a>` : `<span class="font-bold text-gray-800">${song.title}</span>`;
                    
                    html += `<div class="${hasDivider}">
                        <div class="mb-2 text-base">${songLink} <span class="text-xs text-gray-400">(${song.reading || ''})</span></div>
                        <div class="text-sm text-gray-700 space-y-2 leading-relaxed bg-orange-50/50 p-3 rounded-lg border border-orange-100">
                            ${song.single_info ? `<p>ğŸ’¿ ${song.single_info}</p>` : ''}
                            ${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-300 italic">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ æœªåéŒ²</p>'}
                            <div class="pt-2 border-t border-orange-100 text-xs text-gray-600">
                                <p>ğŸ¼ ç·¨æ›²ï¼š${song.arranger || 'ä¸æ˜'}</p>
                                <p>â± å†ç”Ÿæ™‚é–“ï¼š${song.duration || 'ä¸æ˜'}</p>
                                <p>ğŸ¥ BPMï¼š${song.bpm || 'ç¢ºèªä¸­'}</p>
                            </div>
                            <p class="pt-1 text-xs text-orange-700 font-medium">${ageText}</p>
                        </div>
                    </div>`;
                });
            }
            if (data.albums && data.albums.length > 0) {
                if (data.songs && data.songs.length > 0) html += '<div class="text-xs font-bold text-orange-500 border-b border-orange-100 pb-1">ğŸ’¿ åéŒ²ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±</div>';
                data.albums.forEach((disk) => {
                    const songList = disk.songs.map((s, i) => `<li class="py-1 border-b border-orange-50 last:border-0 flex gap-2"><span class="text-orange-400 w-6 text-right font-mono text-xs pt-0.5">${s.order}.</span><span>${s.title}</span></li>`).join('');
                    html += `<div class="bg-orange-50/50 rounded-xl p-4 border border-orange-100">
                        <h3 class="font-bold text-orange-700 mb-1">ğŸ’¿ ${disk.disk_name}</h3>
                        <p class="text-xs text-gray-500 mb-3">${disk.release_date} ç™ºå£²</p>
                        <ul class="text-sm text-gray-700 list-none">${songList}</ul>
                    </div>`;
                });
            }
            html += '</div>';
            html += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(html, 'bot', true);
            lucide.createIcons();
        }

        function handleShiritoriResults(data) {
            if (data.result === 'unknown_song') addMessage(data.message, 'bot');
            else addMessage(data.message, 'bot');
        }

        function addMessage(content, type, isHtml = false) {
            const container = dom.containers[currentMode];
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;
            
            const bubbleClass = type === 'user' ? 'bubble bubble-right text-white' : 'bubble bubble-left bg-white text-gray-800';
            
            // ä¿®æ­£: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²åˆ¶å¾¡ï¼ˆv2.3.1ã®æ–¹å¼ï¼šCSSå¤‰æ•°ã§ä¸€å…ƒç®¡ç†ï¼‰
            let userStyle = '';
            if (type === 'user') {
                userStyle = 'style="background-color: var(--bubble-color);"';
            }

            const iconHtml = type === 'bot' ? `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()">` : '';
            div.innerHTML = type === 'bot' 
                ? `${iconHtml}<div class="${bubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm leading-relaxed">${content}</div>` 
                : `<div class="${bubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm leading-relaxed" ${userStyle}>${content}</div>`;
            
            container.appendChild(div);
            scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const container = dom.containers[currentMode];
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            const msg = LOADING_MESSAGES[currentMode][Math.floor(Math.random() * LOADING_MESSAGES[currentMode].length)];
            div.innerHTML = `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()"><div class="bubble bubble-left bg-white px-4 py-3 shadow-sm"><p class="text-sm text-gray-500 pulse-text">${msg}</p></div>`;
            container.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { const c = dom.containers[currentMode]; c.scrollTop = c.scrollHeight; }
        
        window.toggleModal = function(show) {
            if (show) dom.modal.classList.remove('hidden');
            else dom.modal.classList.add('hidden');
            lucide.createIcons();
        };

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) navigator.clipboard.writeText(cleanText).then(() => showToast("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼"));
            else {
                const ta = document.createElement('textarea');
                ta.value = cleanText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showToast("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼");
            }
        }

        function showToast(msg) {
            dom.toast.textContent = msg; dom.toast.classList.remove('opacity-0');
            setTimeout(() => dom.toast.classList.add('opacity-0'), 2000);
        }
    </script>
</body>
</html>
