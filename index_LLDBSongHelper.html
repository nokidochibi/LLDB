<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LLDB Song Helper">
    <meta name="application-name" content="LLDB Song Helper">
    
    <link rel="apple-touch-icon" href="https://unavatar.io/twitter/noki_dochibi">
    <link rel="icon" href="https://unavatar.io/twitter/noki_dochibi">

    <title>LLDB Song Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. Base & Theme Colors
           ========================================= */
        :root {
            --bg-color: #F8F9FA;       /* Off-White */
            --main-orange: #F4A261;    /* Song Helper Theme */
            --main-sky: #0ea5e9;       /* Title Search Theme */
            --main-pink: #ec4899;      /* Shiritori Theme */
            --bubble-color: #F4A261;
            /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã•ã‚’85pxã«çµ±ä¸€ */
            --nav-height: 85px;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease; 
            overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã€Mainã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .send-btn-active:active { transform: scale(0.9); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .message-row { scroll-margin-top: 6rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .highlight-text {
            color: #ea580c;
            font-weight: bold;
            background-color: #fff7ed;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* å¹ãå‡ºã— (Default) */
        .bubble { position: relative; border-radius: 1.2rem; transition: background-color 0.3s, color 0.3s; }
        .bubble-right::before {
            content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent var(--bubble-color);
        }
        .bubble-left::before {
            content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent;
        }

        /* =========================================
           2. Footer & Tabs (YouTube Style)
           ========================================= */
        footer {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 30;
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            /* Tabã‚¨ãƒªã‚¢ã§padding-bottomã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€footerè‡ªä½“ã®paddingã¯0 */
            padding-bottom: 0;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #search-form {
            padding: 12px;
            background-color: rgba(255,255,255,0.98);
            border-bottom: 1px solid #f3f4f6;
        }

        /* ã‚¿ãƒ–ã‚¨ãƒªã‚¢ */
        #footer-tab-area {
            display: flex;
            width: 100%;
            background-color: white;
            /* é«˜ã•èª¿æ•´: 85px + Safe Area */
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´: ä¸Šå¯„ã›é…ç½® */
        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ä¸Šå¯„ã›é…ç½® */
            justify-content: flex-start;
            padding-top: 12px;
            gap: 4px;
            
            color: #94a3b8;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
            position: relative;
        }

        /* ãƒ†ãƒ¼ãƒã”ã¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è‰²ä»˜ã‘ãƒ»èƒŒæ™¯é€éï¼‰ */
        
        .tab-btn.active {
            font-weight: bold;
            opacity: 1;
            background-color: transparent !important; /* èƒŒæ™¯è‰²ã¯ã¤ã‘ãªã„ */
        }
        
        /* é¸æŠæ™‚ã¯ç·šã®å¤ªã•ã‚’2.5pxã« */
        .tab-btn.active i {
            stroke-width: 2.5px;
        }

        /* Lyrics Mode (Orange) */
        .theme-lyrics .tab-btn[data-tab="lyrics"].active {
            color: var(--main-orange);
        }
        /* Title Mode (Sky) */
        .theme-title .tab-btn[data-tab="title"].active {
            color: var(--main-sky);
        }
        /* Shiritori Mode (Pink) - è£ãƒ¢ãƒ¼ãƒ‰ç”¨ */
        .theme-shiritori .tab-btn[data-tab="lyrics"].active,
        .theme-shiritori .tab-btn[data-tab="title"].active {
             color: var(--main-pink);
        }


        /* ãƒ†ãƒ¼ãƒåˆ¥ã‚«ãƒ©ãƒ¼å®šç¾© */
        .theme-lyrics .text-theme { color: var(--main-orange); }
        .theme-lyrics .bg-theme { background-color: var(--main-orange); }
        .theme-lyrics .bg-theme-soft { background-color: #fff7ed; }
        .theme-lyrics .border-theme { border-color: #ffedd5; }

        .theme-title .text-theme { color: var(--main-sky); }
        .theme-title .bg-theme { background-color: var(--main-sky); }
        .theme-title .bg-theme-soft { background-color: #f0f9ff; }
        .theme-title .border-theme { border-color: #e0f2fe; }

        .theme-shiritori .text-theme { color: var(--main-pink); }
        .theme-shiritori .bg-theme { background-color: var(--main-pink); }
        .theme-shiritori .bg-theme-soft { background-color: #fdf2f8; }
        .theme-shiritori .border-theme { border-color: #fce7f3; }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ (è£ãƒ¢ãƒ¼ãƒ‰) */
        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        body.dark-mode footer {
            background-color: #1e293b;
            border-color: #334155;
        }
        body.dark-mode #search-form {
            background-color: #1e293b;
            border-bottom-color: #334155;
        }
        body.dark-mode #footer-tab-area {
            display: none; /* è£ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã‚¿ãƒ–ã‚’éš ã™ä»•æ§˜ç¶­æŒ */
        }
        body.dark-mode input { color: #fff; }
        body.dark-mode .bg-gray-100 { background-color: #334155; border-color: #475569; }
        body.dark-mode .bubble-left { background-color: #334155; color: #f1f5f9; }
        body.dark-mode .bubble-left::before { border-color: transparent #334155 transparent transparent; }
        body.dark-mode .bot-icon { border-color: #475569; background-color: #1e293b; }
        body.dark-mode button.bg-white { background-color: #1e293b; border-color: #ec4899; color: #fbcfe8; }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .tap-highlight { animation: highlight 0.3s ease-out; }
        @keyframes highlight { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: brightness(1.2); } 100% { transform: scale(1); } }

        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
    </style>
</head>
<body id="app-body" class="theme-lyrics h-screen flex flex-col transition-colors duration-300">

    <!-- 1. æ­Œè©(ãƒ•ãƒ¬ãƒ¼ã‚º)ãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-lyrics" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼
                </p>
            </div>
        </div>
    </main>

    <!-- 2. æ¥½æ›²DBãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-title" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚„åéŒ²æ›²é †ã‚’æ•™ãˆã‚‹ã‚ˆğŸ’¿
                </p>
            </div>
        </div>
    </main>

    <!-- 3. ã—ã‚Šã¨ã‚Šãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-shiritori" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    ã•ãã€ã—ã‚Šã¨ã‚Šã®æ™‚é–“ã ã€‚<br>
                    æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã¿ã‚ˆã€‚<br>
                    ï¼ˆä¾‹ï¼šèŠ±ç«ï¼‰
                </p>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer>
        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="search-form" class="flex items-center gap-2">
            <div class="flex-1 bg-gray-100 rounded-xl flex items-center px-4 py-3 transition-colors focus-within:bg-white focus-within:ring-1 focus-within:ring-gray-300 border border-transparent focus-within:border-gray-300">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-base placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            
            <button type="submit" 
                class="send-btn-active text-theme p-3 rounded-full hover:bg-theme-soft transition flex-shrink-0 shadow-sm border border-transparent hover:border-theme bg-white">
                <i data-lucide="send" class="w-5 h-5 fill-current transition-colors duration-300"></i>
            </button>
        </form>

        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div id="footer-tab-area">
            <button id="tab-lyrics" data-tab="lyrics" onclick="switchTab('lyrics')" class="tab-btn active">
                <i data-lucide="music" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒ•ãƒ¬ãƒ¼ã‚º</span>
            </button>
            <div class="w-[1px] bg-gray-100 my-3"></div>
            <button id="tab-title" data-tab="title" onclick="switchTab('title')" class="tab-btn">
                <i data-lucide="disc" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">æ¥½æ›²</span>
            </button>
        </div>
    </footer>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <!-- Readme Modal -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4 border-b border-gray-50 pb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-500 p-1.5 rounded-lg">ğŸŒ·</span>
                    About App
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1 bg-gray-50 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-6 text-sm text-gray-600 leading-relaxed overflow-y-auto max-h-[60vh] px-1 pb-2 scrollbar-hide">
                <div class="text-center mb-2">
                    <p class="text-[10px] font-bold text-orange-400 tracking-widest mb-1">WELCOME</p>
                    <p class="text-gray-700 font-medium">ãŠèŠ±ã¡ã‚ƒã‚“ã®ãŸã‚ã®<br>ãƒã‚±ãƒƒãƒˆè¾æ›¸ã§ã™ğŸŒ·</p>
                </div>
                <div class="space-y-4">
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="music" class="w-4 h-4"></i> ãƒ•ãƒ¬ãƒ¼ã‚ºã‹ã‚‰æ¢ã™</h3>
                        <p class="text-xs leading-5">èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®æ­Œè©ãŒå«ã¾ã‚Œã‚‹æ›²ã‚’æ¢ã—ã¾ã™ã€‚<br><span class="text-orange-400/80 mt-1.5 block text-[10px]">ğŸ’¡ã€Œç”˜ã„åŒ‚ã„ã«ã€ã€Œã‚ã‚Œã¯ã€ãªã©ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§ã‚‚OKï¼</span></p>
                    </div>
                    <div class="bg-sky-50/50 p-4 rounded-xl border border-sky-100">
                        <h3 class="font-bold text-sky-600 flex items-center gap-2 mb-2"><i data-lucide="disc" class="w-4 h-4"></i> æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹</h3>
                        <p class="text-xs leading-5">æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‹ã‚‰ã€ç™ºå£²æ—¥ãƒ»åéŒ²é †ãƒ»å½“æ™‚ã®aikoã®å¹´é½¢ãªã©ã‚’æ•™ãˆã¾ã™ã€‚<br><span class="text-sky-400/80 mt-1.5 block text-[10px]">ğŸ’¡ã€Œãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«ã€ã‚„ã€Œæ™‚ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆã€ãªã©ã§æ¤œç´¢ã—ã¦ã¿ã¦ï¼</span></p>
                    </div>
                    <div class="bg-gray-800 text-gray-300 p-4 rounded-xl border border-gray-700 relative overflow-hidden group shadow-md">
                        <div class="absolute -right-6 -top-6 bg-pink-500/20 w-20 h-20 rounded-full blur-xl group-hover:bg-pink-500/30 transition duration-500"></div>
                        <h3 class="font-bold text-pink-400 flex items-center gap-2 mb-2 relative z-10"><i data-lucide="gamepad-2" class="w-4 h-4"></i> Secret Mode</h3>
                        <p class="text-xs leading-5 relative z-10"><span class="text-pink-300 font-bold">ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³</span>ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨...</p>
                    </div>
                </div>
                <div class="text-center pt-6 border-t border-gray-100">
                    <p class="text-[10px] text-gray-400 mb-2">Developed by</p>
                    <a href="https://twitter.com/noki_dochibi" target="_blank" class="inline-flex items-center gap-2 text-xs font-bold text-gray-600 hover:text-orange-500 transition bg-gray-50 px-4 py-2 rounded-full border border-gray-100 hover:border-orange-200 hover:bg-orange-50">
                        <img src="https://unavatar.io/twitter/noki_dochibi" class="w-5 h-5 rounded-full shadow-sm"> @noki_dochibi
                    </a>
                    <p class="text-[10px] text-gray-300 mt-4 font-mono tracking-wider">v2.1.0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = 'v2.1.0';
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;

        // çŠ¶æ…‹ç®¡ç†å¤‰æ•°
        let currentMode = 'lyrics'; 
        let lastMode = 'lyrics'; 
        let isDarkMode = false; 

        const LOADING_MESSAGES = {
            lyrics: ["aikoã‹ã‚‰ã®telepathyã‚’å—ä¿¡ä¸­...", "ãã‚“ãªã“ã¨ã‚ˆã‚Šãƒ‘ãƒ¼ãƒ†ã‚£æŠœã‘å‡ºã•ãªã„ï¼Ÿ"],
            title: ["ãŠã£ï¼ãã®æ›²ãªã‚‰ç¢ºã‹ã­...", "ä¿ºã‚‚ãã‚Œå¥½ãã ã‚ˆï¼å¾…ã£ã¦ã¦..."],
            shiritori: ["ä¿ºã«å‹è² ã‚’ä»•æ›ã‘ã‚‹ã¨ã¯ã„ã„åº¦èƒ¸ã ã€‚", "ãªã‚‹ã»ã©ã€ãã†æ¥ãŸã‹..."]
        };

        const dom = {
            body: document.getElementById('app-body'),
            containerLyrics: document.getElementById('chat-container-lyrics'),
            containerTitle: document.getElementById('chat-container-title'),
            containerShiritori: document.getElementById('chat-container-shiritori'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('readme-modal'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            botIcons: document.querySelectorAll('.bot-icon')
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            dom.botIcons.forEach(img => img.src = ICON_URL);
            new Image().src = ICON_URL;
        });

        // ==========================================
        // ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡
        // ==========================================

        window.activateSecretMode = function() {
            const activeIcon = document.querySelector(`#chat-container-${currentMode} .bot-icon`);
            if (activeIcon) {
                activeIcon.classList.remove('tap-highlight');
                void activeIcon.offsetWidth;
                activeIcon.classList.add('tap-highlight');
            }

            if (currentMode === 'shiritori') {
                isDarkMode = false;
                dom.body.classList.remove('dark-mode');
                if (!lastMode || lastMode === 'shiritori') {
                    lastMode = 'lyrics';
                }
                switchTab(lastMode);
            } else {
                lastMode = currentMode;
                isDarkMode = true;
                dom.body.classList.add('dark-mode');
                switchTab('shiritori');
            }
        };

        window.switchTab = function(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            dom.tabBtns.forEach(btn => {
                if (btn.dataset.tab === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            dom.containerLyrics.classList.add('hidden');
            dom.containerTitle.classList.add('hidden');
            dom.containerShiritori.classList.add('hidden');

            if (mode === 'lyrics') {
                dom.body.classList.replace('theme-title', 'theme-lyrics');
                dom.body.classList.replace('theme-shiritori', 'theme-lyrics');
                dom.containerLyrics.classList.remove('hidden');
                dom.searchInput.placeholder = "ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«";
                document.documentElement.style.setProperty('--bubble-color', '#F4A261');

            } else if (mode === 'title') {
                dom.body.classList.replace('theme-lyrics', 'theme-title');
                dom.body.classList.replace('theme-shiritori', 'theme-title');
                dom.containerTitle.classList.remove('hidden');
                dom.searchInput.placeholder = "ä¾‹ï¼šãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«";
                document.documentElement.style.setProperty('--bubble-color', '#0ea5e9');

            } else if (mode === 'shiritori') {
                dom.body.classList.replace('theme-lyrics', 'theme-shiritori');
                dom.body.classList.replace('theme-title', 'theme-shiritori');
                dom.containerShiritori.classList.remove('hidden');
                dom.searchInput.placeholder = "æ›²åã‚’æ­£ã—ã„è¡¨è¨˜ã§å…¥åŠ›ã—ã¦ã­";
                document.documentElement.style.setProperty('--bubble-color', '#ec4899');
            }
        };

        function getActiveContainer() {
            if (currentMode === 'lyrics') return dom.containerLyrics;
            if (currentMode === 'title') return dom.containerTitle;
            return dom.containerShiritori;
        }

        window.sendShiritoriAnswer = function(text) {
            dom.searchInput.value = text;
            dom.searchForm.dispatchEvent(new Event('submit'));
        };

        dom.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = dom.searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            dom.searchInput.value = '';
            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'success') {
                    if (currentMode === 'lyrics') handleLyricsResults(data);
                    else if (currentMode === 'title') handleTitleResults(data);
                    else handleShiritoriResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }
            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡å¤±æ•—ï¼ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        function handleShiritoriResults(data) {
            if (data.result === 'unknown_song') {
                addMessage(data.message, 'bot');
                return;
            }

            if (data.result === 'user_lose' || data.result === 'user_win') {
                let contentHtml = `<div class="flex flex-col gap-2"><p>${data.message}</p>`;
                contentHtml += `
                    <div class="flex gap-2 mt-3">
                        <button onclick="restartShiritori()" class="flex-1 bg-pink-500 text-white border border-pink-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-pink-600 active:scale-95 transition">
                            ã‚‚ã†ä¸€åº¦éŠã¶
                        </button>
                        <button onclick="exitShiritori()" class="flex-1 bg-gray-700 text-white border border-gray-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-600 active:scale-95 transition">
                            ãŠã—ã¾ã„ã«ã™ã‚‹
                        </button>
                    </div>`;
                contentHtml += `</div>`;
                addMessage(contentHtml, 'bot');
                return;
            }

            let contentHtml = `<div class="flex flex-col gap-2"><p>${data.message}</p>`;
            if (data.hints && data.hints.length > 0) {
                const hintId = 'hint-' + Date.now();
                contentHtml += `
                    <div class="mt-2">
                        <button onclick="document.getElementById('${hintId}').classList.toggle('hidden')" class="text-xs font-bold text-pink-500 flex items-center gap-1 hover:underline">
                            <i data-lucide="lightbulb" class="w-3 h-3"></i> ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                        </button>
                        <div id="${hintId}" class="hidden mt-2 flex flex-wrap gap-2 animate-fade-in">`;
                data.hints.forEach(cand => {
                    contentHtml += `<button onclick="sendShiritoriAnswer('${cand.title}')" class="bg-white border border-pink-200 text-pink-600 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm hover:bg-pink-50 active:scale-95 transition">${cand.title}</button>`;
                });
                contentHtml += `</div></div>`;
            } else {
                 contentHtml += `<p class="text-xs text-gray-400 mt-1">ï¼ˆãƒ’ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„...ï¼è‡ªåŠ›ã§é ‘å¼µã£ã¦ï¼ï¼‰</p>`;
            }
            contentHtml += `</div>`;
            addMessage(contentHtml, 'bot');
            lucide.createIcons();
        }

        window.restartShiritori = function() {
            dom.containerShiritori.innerHTML = `
                <div class="flex items-start space-x-2">
                    <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" src="${ICON_URL}">
                    <div class="bubble bubble-left bg-white px-4 py-3 shadow-sm max-w-[80%] text-sm break-words leading-relaxed">
                        <p>ã—ã‚Šã¨ã‚Šãƒªã‚»ãƒƒãƒˆï¼<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ï¼ˆä¾‹ï¼šèŠ±ç«ï¼‰</p>
                    </div>
                </div>`;
        };

        window.exitShiritori = function() {
            activateSecretMode();
        };

        function handleLyricsResults(data) {
            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­Œè©ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è¡¨è¨˜ã«ã—ã¦ã¿ã¦ï¼`, 'bot');
                return;
            }
            let contentHtml = '<div class="flex flex-col animate-fade-in">';
            if (data.fuzzy_type) {
                contentHtml += `<div class="bg-orange-100/50 border border-orange-200 rounded-lg p-2.5 mb-3 text-xs text-orange-700">
                    ã€Œ<span class="font-bold">${data.query}</span>ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©ã€<br>
                    ã€Œ<span class="font-bold text-orange-600">${data.actual_query}</span>ã€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆï¼ (${data.fuzzy_type})
                </div>`;
            }
            const highlightWord = data.fuzzy_type ? data.actual_query : data.query;
            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-theme' : '';
                const highlightedPhrase = item.phrase.replace(new RegExp(`(${highlightWord})`, 'gi'), '<span class="highlight-text">$1</span>');
                contentHtml += `<div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" class="${borderClass} py-3 cursor-pointer hover:bg-theme-soft transition relative group select-none"><p class="text-sm font-medium text-gray-700 leading-relaxed pl-1">${highlightedPhrase} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span></p></div>`;
            });
            contentHtml += '</div>';
            const uniqueSongs = new Set(data.results.map(item => item.title)).size;
            const allText = data.results.map(item => item.display_text).join('\\n').replace(/'/g, "\\'");
            contentHtml += `<div class="animate-fade-in mt-3 pt-2 border-t border-dashed border-theme"><div class="flex flex-wrap items-center justify-between gap-2"><p class="text-[10px] text-gray-400"><span class="font-bold">${uniqueSongs}æ›²</span>ã®ä¸­ã§ã€<span class="font-bold">è¨ˆ${data.results.length}ç®‡æ‰€</span>è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª</p><button onclick="copyToClipboard('${allText}')" class="text-[10px] text-theme hover:text-opacity-80 flex items-center gap-1 bg-theme-soft px-3 py-1.5 rounded-full transition shadow-sm border border-theme"><i data-lucide="copy" class="w-3 h-3"></i> ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button></div></div>`;
            contentHtml += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        function handleTitleResults(data) {
             if ((!data.songs || data.songs.length === 0) && (!data.albums || data.albums.length === 0)) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­£å¼åç§°ï¼ˆã¾ãŸã¯ãã®ä¸€éƒ¨ï¼‰ã‚’æ•™ãˆã¦ã­ï¼`, 'bot');
                return;
            }
            let contentHtml = '<div class="flex flex-col gap-6 animate-fade-in">';
            if (data.songs && data.songs.length > 0) {
                let songSection = '<div class="flex flex-col gap-4">';
                if (data.albums && data.albums.length > 0) songSection += '<div class="text-xs font-bold text-sky-500 border-b border-sky-100 pb-1">ğŸµ æ›²ã®æ¤œç´¢çµæœ</div>';
                data.songs.forEach((song, idx) => {
                    const hasDivider = idx > 0 ? 'border-t border-sky-100 pt-4' : '';
                    const ageText = song.age_at_release ? `ãƒªãƒªãƒ¼ã‚¹æ™‚ã®aikoã¯<span class="font-bold text-sky-600">${song.age_at_release}æ­³</span>ã ã‚ˆã€‚` : '';
                    const songLink = song.link_url ? `<a href="${song.link_url}" target="_blank" class="text-sky-600 underline font-bold hover:text-sky-400">${song.title}</a>` : `<span class="font-bold text-gray-800">${song.title}</span>`;
                    songSection += `<div class="${hasDivider}"><div class="mb-2 text-base">${songLink} <span class="text-xs text-gray-400">(${song.reading || ''})</span></div><div class="text-sm text-gray-700 space-y-2 leading-relaxed bg-sky-50/50 p-3 rounded-lg border border-sky-100">${song.single_info ? `<p>ğŸ’¿ ${song.single_info}</p>` : ''}${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-400">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ ã«ã¯æœªåéŒ²ã ã‚ˆã€‚</p>'}<div class="pt-2 border-t border-sky-100 text-xs text-gray-600"><p>ğŸ¼ ç·¨æ›²ï¼š${song.arranger || 'ä¸æ˜'}</p><p>â± å†ç”Ÿæ™‚é–“ï¼š${song.duration || 'ä¸æ˜'}</p><p>ğŸ¥ BPMï¼š${song.bpm || 'ç¢ºèªä¸­'}</p></div><p class="pt-1 text-xs text-sky-700 font-medium">${ageText}</p></div></div>`;
                });
                songSection += '</div>';
                contentHtml += songSection;
            }
            if (data.albums && data.albums.length > 0) {
                let albumSection = '<div class="flex flex-col gap-4">';
                if (data.songs && data.songs.length > 0) albumSection += '<div class="text-xs font-bold text-sky-500 border-b border-sky-100 pb-1">ğŸ’¿ åéŒ²ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±</div>';
                data.albums.forEach((disk) => {
                    const songList = disk.songs.map((s, i) => `<li class="py-1 border-b border-sky-50 last:border-0 flex gap-2"><span class="text-sky-400 w-6 text-right font-mono text-xs pt-0.5">${s.order}.</span><span>${s.title}</span></li>`).join('');
                    albumSection += `<div class="bg-sky-50/50 rounded-xl p-4 border border-sky-100"><h3 class="font-bold text-sky-700 mb-1">ğŸ’¿ ${disk.disk_name}</h3><p class="text-xs text-gray-500 mb-3">${disk.release_date} ç™ºå£²</p><ul class="text-sm text-gray-700 list-none">${songList}</ul></div>`;
                });
                albumSection += '</div>';
                contentHtml += albumSection;
            }
            contentHtml += '</div>';
            contentHtml += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-sky-300 hover:text-sky-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        function addMessage(htmlOrText, type, shouldScroll = true) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;
            const bubbleClass = type === 'user' ? 'bubble bubble-right text-white' : 'bubble bubble-left bg-white text-gray-800';
            
            let userBgClass = 'bg-gray-500';
            if (currentMode === 'lyrics') userBgClass = 'bg-orange-500';
            else if (currentMode === 'title') userBgClass = 'bg-sky-500';
            else if (currentMode === 'shiritori') userBgClass = 'bg-pink-500';

            const finalBubbleClass = type === 'user' ? `${bubbleClass} ${userBgClass}` : bubbleClass;
            const iconHtml = type === 'bot' ? `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()">` : '';
            div.innerHTML = type === 'bot' ? iconHtml + `<div class="${finalBubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">${htmlOrText}</div>` : `<div class="${finalBubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">${htmlOrText}</div>`;
            getActiveContainer().appendChild(div);
            if (shouldScroll) scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            const msgs = LOADING_MESSAGES[currentMode];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            div.innerHTML = `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()"><div class="bubble bubble-left bg-white px-4 py-3 shadow-sm"><p class="text-sm text-gray-500 pulse-text">${randomMsg}</p></div>`;
            getActiveContainer().appendChild(div);
            scrollToBottom();
            
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { const container = getActiveContainer(); container.scrollTop = container.scrollHeight; }
        
        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) { navigator.clipboard.writeText(cleanText).then(showToast); } 
            else { const ta = document.createElement('textarea'); ta.value = cleanText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast(); }
        }
        function showToast() { dom.toast.classList.remove('opacity-0'); setTimeout(() => dom.toast.classList.add('opacity-0'), 2000); }
        function toggleModal(show) {
            if (show) { dom.modal.classList.remove('hidden'); setTimeout(() => { dom.modal.querySelector('div:last-child').classList.remove('modal-enter'); dom.modal.querySelector('div:last-child').classList.add('modal-enter-active'); }, 10); } 
            else { dom.modal.classList.add('hidden'); }
        }
    </script>
</body>
</html>
