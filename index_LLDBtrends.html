<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLDB trends</title>
    
    <!-- Tailwind CSS & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
            padding-top: 0px; /* è¦ªãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ† */
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes stretch { 0% { width: 0; } 100% { width: 100%; } }
        .animate-stretch { animation: stretch 3s ease-out forwards; }

        .sortable-th { cursor: pointer; user-select: none; }
        .sortable-th::after { content: ''; display: inline-block; margin-left: 2px; width: 0; height: 0; border: 4px solid transparent; opacity: 0.3; vertical-align: middle; }
        .sortable-th.asc::after { border-bottom-color: #334155; border-top: none; opacity: 1; }
        .sortable-th.desc::after { border-top-color: #334155; border-bottom: none; opacity: 1; }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* ã‚¿ãƒ– */
        .tab-button {
            border-bottom: 2px solid transparent;
            color: #64748b;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: bold;
        }

        /* ã‚°ãƒ©ãƒ•ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Loading Screen -->
    <div id="loading-screen" class="flex flex-col items-center justify-center pt-10 pb-6 bg-slate-50 transition-all duration-500">
        <div class="flex items-baseline mb-2">
            <span id="counting-number" class="text-4xl font-bold text-slate-700">0</span>
            <span class="text-sm text-slate-500 ml-1">å›è¦–è´</span>
        </div>
        <div class="w-64 h-1 bg-slate-200 rounded-full overflow-hidden relative">
            <div class="h-full bg-blue-500 absolute top-0 left-0 animate-stretch"></div>
        </div>
        <p class="text-xs text-slate-400 mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="px-2 opacity-0 transition-opacity duration-500 hidden">
        
        <!-- Tab Navigation -->
        <div class="flex border-b border-slate-200 mb-4 sticky top-0 bg-slate-50 z-10">
            <button onclick="switchTab('views')" class="tab-button active flex-1 py-3 text-sm text-center">YTè¦–è´å›æ•°</button>
            <button onclick="switchTab('followers')" class="tab-button flex-1 py-3 text-sm text-center">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</button>
        </div>

        <!-- Tab 1: YTè¦–è´å›æ•° -->
        <div id="tab-views" class="tab-content">
            <!-- Filter Controls -->
            <div class="bg-white rounded-xl p-3 card-shadow mb-4 flex flex-wrap gap-2 justify-center">
                <button class="filter-btn active" data-cat="isMV">MV</button>
                <button class="filter-btn active" data-cat="isFullOther">Live</button>
                <button class="filter-btn active" data-cat="isNYMovie">New Year</button>
                <button class="filter-btn active" data-cat="isOther">ãã®ä»–</button>
            </div>

            <p class="text-center text-[10px] text-slate-400 mb-2">é …ç›®ã‚¿ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆ</p>

            <!-- Data Table -->
            <div class="bg-white rounded-xl overflow-hidden card-shadow relative">
                <div id="update-time" class="absolute top-2 right-3 text-[10px] text-slate-400 font-mono"></div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200 text-xs">
                            <tr>
                                <th class="p-2 text-center w-6">#</th>
                                <th class="p-2 min-w-[140px] whitespace-normal">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th class="p-2 text-right cursor-pointer sortable-th desc" data-key="totalViews">è¦–è´å›æ•°</th>
                                <th class="p-2 text-center cursor-pointer sortable-th" data-key="publishedDate">å…¬é–‹æ—¥</th>
                                <th class="p-2 text-right cursor-pointer sortable-th" data-key="avgDailyViews">å¹³å‡/æ—¥<br><span class="text-[9px] font-normal">(å…¨æœŸé–“)</span></th>
                                <th class="p-2 text-right cursor-pointer sortable-th" data-key="avgViews7Days">å¹³å‡/æ—¥<br><span class="text-[9px] font-normal">(éå»7æ—¥)</span></th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100">
                            <!-- JSã§ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ -->
        <div id="tab-followers" class="tab-content hidden">
            <div class="space-y-6 pb-20">
                <!-- Youtube Graph -->
                <div class="bg-white rounded-xl p-4 card-shadow">
                    <h3 class="font-bold text-red-600 flex items-center gap-2 mb-4">
                        <i data-lucide="youtube" class="w-5 h-5"></i> Youtubeç™»éŒ²è€…æ•°
                    </h3>
                    <div class="h-64 relative w-full">
                        <canvas id="chart-youtube"></canvas>
                        <div id="loader-youtube" class="absolute inset-0 flex items-center justify-center bg-white/80 text-xs text-slate-400">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>

                <!-- Twitter Graph -->
                <div class="bg-white rounded-xl p-4 card-shadow">
                    <h3 class="font-bold text-sky-500 flex items-center gap-2 mb-4">
                        <i data-lucide="twitter" class="w-5 h-5"></i> Twitterãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°
                    </h3>
                    <div class="h-64 relative w-full">
                        <canvas id="chart-twitter"></canvas>
                        <div id="loader-twitter" class="absolute inset-0 flex items-center justify-center bg-white/80 text-xs text-slate-400">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                
                <p class="text-center text-xs text-slate-400 mt-4">â€» ãƒ‡ãƒ¼ã‚¿ã¯æ¯æ—¥è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-slate-400 text-xs pb-8">
            <p class="mb-2">Produced with ğŸ’™</p>
            <a href="https://lit.link/nokidochibi" target="_blank" class="underline hover:text-slate-600">nokidochibi</a>
        </div>
    </main>

    <!-- Graph Modal (Individual Video) -->
    <div id="graph-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeGraphModal()">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeGraphModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 id="graph-title" class="text-lg font-bold text-slate-700 mb-4 pr-8 leading-tight"></h3>
            <div class="h-64 w-full relative">
                <canvas id="dailyViewsChart"></canvas>
                <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 text-slate-500 text-sm">
                    ã‚°ãƒ©ãƒ•ä½œæˆä¸­...ğŸŒ±
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        const GAS_API_URL = parent.GAS_API_URL || "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
        
        let allData = [];
        let filteredData = [];
        let sortKey = 'totalViews';
        let sortDesc = true;
        let chartInstance = null;
        let followersDataLoaded = false;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initFilterButtons();
            initSortHeaders();
            fetchData(); // å‹•ç”»ãƒ‡ãƒ¼ã‚¿å–å¾—
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'followers' && !followersDataLoaded) {
                fetchFollowersData();
                followersDataLoaded = true;
            }
        }

        // ----------------------------------------
        // Tab 1: YTè¦–è´å›æ•° Logic
        // ----------------------------------------

        function initFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                updateFilterBtnStyle(btn);
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    updateFilterBtnStyle(btn);
                    applyFilterAndRender();
                });
            });
        }

        function updateFilterBtnStyle(btn) {
            if (btn.classList.contains('active')) {
                btn.className = 'filter-btn active px-3 py-1.5 rounded-full text-[10px] font-bold border transition-colors bg-blue-500 text-white border-blue-600';
            } else {
                btn.className = 'filter-btn px-3 py-1.5 rounded-full text-[10px] font-bold border transition-colors bg-white text-slate-500 border-slate-200 hover:bg-slate-50';
            }
        }

        function initSortHeaders() {
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    if (sortKey === key) {
                        sortDesc = !sortDesc;
                    } else {
                        sortKey = key;
                        sortDesc = true;
                    }
                    document.querySelectorAll('.sortable-th').forEach(t => t.classList.remove('asc', 'desc', 'text-blue-600'));
                    th.classList.add(sortDesc ? 'desc' : 'asc');
                    th.classList.add('text-blue-600');
                    renderTable();
                });
            });
        }

        async function fetchData() {
            try {
                const res = await fetch(`${GAS_API_URL}?action=getTrendsData`);
                const json = await res.json();

                if (json.status === 'error' || !json.data) throw new Error(json.message || 'ãƒ‡ãƒ¼ã‚¿ãªã—');

                allData = json.data;
                document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${json.lastUpdateTime || '-'}`;
                
                completeLoading(json.maxTotalViews || 1000000);
                applyFilterAndRender();

            } catch (err) {
                console.error(err);
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 text-xs">èª­ã¿è¾¼ã¿å¤±æ•—<br>${err.message}</p>`;
            }
        }

        function completeLoading(targetNum) {
            const el = document.getElementById('counting-number');
            let current = 0;
            const duration = 800;
            const step = targetNum / (duration / 16);
            const timer = setInterval(() => {
                current += step;
                if (current >= targetNum) {
                    current = targetNum;
                    clearInterval(timer);
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('main-content').classList.remove('hidden'); // ã¾ãšè¡¨ç¤º
                        // å°‘ã—é…ã‚‰ã›ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
                        setTimeout(() => document.getElementById('main-content').classList.remove('opacity-0'), 50);
                    }, 300);
                }
                el.textContent = Math.floor(current).toLocaleString();
            }, 16);
        }

        function applyFilterAndRender() {
            const activeCats = Array.from(document.querySelectorAll('.filter-btn.active')).map(btn => btn.dataset.cat);
            filteredData = allData.filter(item => activeCats.some(cat => item[cat] === '1' || item[cat] === 1));
            renderTable();
        }

        function formatTitle(title) {
            // ã€ã€ã‹ã€Œã€ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦å¤ªå­—ã«ã™ã‚‹ã€‚ãã‚Œä»¥å¤–ã¯å°ã•ãã€‚
            // ä¾‹: aikoã€ã‚«ãƒ–ãƒˆãƒ ã‚·ã€Music Video -> <small>aiko</small><br><b>ã‚«ãƒ–ãƒˆãƒ ã‚·</b><br><small>Music Video</small>
            
            // ç°¡æ˜“çš„ãªå®Ÿè£…: æœ€åˆã®ã‚«ãƒƒã‚³ã®ä¸­èº«ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã™ã‚‹
            const match = title.match(/([ã€ã€Œ])(.*?)([ã€ã€])(.*)/);
            if (match) {
                const prefix = title.substring(0, match.index);
                const content = match[2];
                const suffix = match[4];
                return `<span class="text-[10px] text-slate-400">${prefix}</span><br><span class="font-bold text-slate-700 text-sm">ã€${content}ã€</span><br><span class="text-[10px] text-slate-400">${suffix}</span>`;
            }
            // ã‚«ãƒƒã‚³ãŒãªã„å ´åˆã¯ãã®ã¾ã¾
            return `<span class="font-bold text-slate-700 text-sm">${title}</span>`;
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            filteredData.sort((a, b) => {
                let va = a[sortKey], vb = b[sortKey];
                if (sortKey === 'publishedDate') { va = new Date(va).getTime(); vb = new Date(vb).getTime(); }
                else if (typeof va === 'string') { va = parseFloat(va.replace(/,/g, '')) || 0; vb = parseFloat(vb.replace(/,/g, '')) || 0; }
                return sortDesc ? vb - va : va - vb;
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // æœ€å¤§å€¤è¨ˆç®—ï¼ˆğŸ‘‘ ğŸ”¥ç”¨ï¼‰
            const maxAvgAll = Math.max(...filteredData.map(d => parseFloat(d.avgDailyViews) || 0));
            const maxAvg7 = Math.max(...filteredData.map(d => {
                const v = parseFloat(d.avgViews7Days);
                return isNaN(v) ? -1 : v;
            }));
            const maxViews = Math.max(...filteredData.map(d => parseFloat(d.totalViews) || 0));

            filteredData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0';
                
                const barWidth = ((parseFloat(item.totalViews) || 0) / maxViews) * 100;
                const pubDate = new Date(item.publishedDate);
                const dateStr = `<span class="text-[10px] text-slate-400">${pubDate.getFullYear()}</span><br><span class="font-bold text-slate-600">${pubDate.getMonth()+1}/${pubDate.getDate()}</span>`;

                const avgAll = Math.round(parseFloat(item.avgDailyViews) || 0);
                const avg7Val = parseFloat(item.avgViews7Days);
                const avg7 = isNaN(avg7Val) ? '-' : Math.round(avg7Val);
                
                // ãƒãƒƒã‚¸
                const badgeAll = (avgAll > 0 && avgAll === Math.round(maxAvgAll)) ? '<span class="absolute -top-3 right-0 text-lg">ğŸ‘‘</span>' : '';
                const badge7 = (avg7 !== '-' && avg7 > 0 && avg7 === Math.round(maxAvg7)) ? '<span class="absolute -top-3 right-0 text-lg">ğŸ”¥</span>' : '';

                tr.innerHTML = `
                    <td class="p-2 text-center text-[10px] font-bold text-slate-400">${index + 1}</td>
                    <td class="p-2 leading-tight">
                        <a href="${item.url}" target="_blank" class="block">
                            ${formatTitle(item.title)}
                        </a>
                    </td>
                    <td class="p-2 text-right align-middle">
                        <div class="flex flex-col items-end cursor-pointer w-full" onclick="openGraph('${item.url}', '${item.title.replace(/'/g, "\\'")}')">
                            <span class="font-bold text-blue-600 text-xs">${Number(item.totalViews).toLocaleString()}</span>
                            <div class="w-full max-w-[80px] h-1 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                <div class="h-full bg-blue-400" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="p-2 text-center text-xs leading-tight">${dateStr}</td>
                    <td class="p-2 text-right text-xs font-mono relative">
                        <div class="relative inline-block">
                            ${badgeAll}
                            ${avgAll.toLocaleString()}
                        </div>
                    </td>
                    <td class="p-2 text-right text-xs font-mono relative">
                        <div class="relative inline-block">
                            ${badge7}
                            ${item.avgViews7Days === '(é›†è¨ˆä¸­)' ? '<span class="text-orange-400 text-[9px]">é›†è¨ˆä¸­</span>' : avg7.toLocaleString()}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ----------------------------------------
        // Tab 2: Followers Graph Logic
        // ----------------------------------------

        async function fetchFollowersData() {
            try {
                const res = await fetch(`${GAS_API_URL}?action=getFollowersHistory`);
                const json = await res.json();
                
                document.getElementById('loader-youtube').style.display = 'none';
                document.getElementById('loader-twitter').style.display = 'none';

                if (json.status === 'success' && json.data.length > 0) {
                    renderFollowerChart('chart-youtube', json.data, 'youtube', '#ef4444');
                    renderFollowerChart('chart-twitter', json.data, 'twitter', '#0ea5e9');
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderFollowerChart(canvasId, data, key, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // æ—¥ä»˜ã¨æ•°å€¤ã‚’æŠ½å‡ºï¼ˆnullé™¤å¤–ï¼‰
            const validData = data.filter(d => d[key] !== null);
            const labels = validData.map(d => d.date.substring(5)); // æœˆ/æ—¥
            const values = validData.map(d => d[key]);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç™»éŒ²è€…æ•°',
                        data: values,
                        borderColor: color,
                        backgroundColor: color + '20', // Opacity
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: color,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { font: {size: 10} }
                        },
                        x: {
                            ticks: { font: {size: 10}, maxTicksLimit: 7 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ----------------------------------------
        // Graph Modal Logic
        // ----------------------------------------
        
        async function openGraph(url, title) {
            const modal = document.getElementById('graph-modal');
            const titleEl = document.getElementById('graph-title');
            const loading = document.getElementById('graph-loading');
            
            titleEl.textContent = title;
            modal.classList.remove('hidden');
            loading.style.display = 'flex';

            if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

            try {
                const res = await fetch(`${GAS_API_URL}?action=getTrendGraph&url=${encodeURIComponent(url)}`);
                const json = await res.json();
                loading.style.display = 'none';
                if (json.status === 'success' && json.data.length > 0) {
                    renderChart(json.data);
                }
            } catch (err) { console.error(err); loading.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼"; }
        }

        function closeGraphModal() { document.getElementById('graph-modal').classList.add('hidden'); }

        function renderChart(dailyData) {
            const ctx = document.getElementById('dailyViewsChart').getContext('2d');
            const labels = dailyData.map(d => d.date.substring(5));
            const values = dailyData.map(d => d.views);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è¦–è´å›æ•°',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { font: {size:10} } },
                        x: { grid: { display: false }, ticks: { font: {size:10}, maxTicksLimit: 6 } }
                    }
                }
            });
        }
    </script>
</body>
</html>
