<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLDB trends</title>
    
    <!-- Tailwind CSS & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff; /* LLDB trends color (Blue base) */
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
        }
        
        /* è¦ªãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ†ã ã‘ä½™ç™½ã‚’ç©ºã‘ã‚‹ */
        body { padding-top: 0px; }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes stretch { 0% { width: 0; } 100% { width: 100%; } }
        .animate-stretch { animation: stretch 3s ease-out forwards; }

        .sortable-th { cursor: pointer; user-select: none; }
        .sortable-th::after { content: ''; display: inline-block; margin-left: 4px; width: 0; height: 0; border: 4px solid transparent; opacity: 0.3; vertical-align: middle; }
        .sortable-th.asc::after { border-bottom-color: #334155; border-top: none; opacity: 1; }
        .sortable-th.desc::after { border-top-color: #334155; border-bottom: none; opacity: 1; }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* ã‚°ãƒ©ãƒ•ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Loading Screen -->
    <div id="loading-screen" class="flex flex-col items-center justify-center pt-10 pb-6 bg-slate-50 transition-all duration-500">
        <div class="flex items-baseline mb-2">
            <span id="counting-number" class="text-4xl font-bold text-slate-700">0</span>
            <span class="text-sm text-slate-500 ml-1">å›è¦–è´</span>
        </div>
        <div class="w-64 h-1 bg-slate-200 rounded-full overflow-hidden relative">
            <div class="h-full bg-blue-500 absolute top-0 left-0 animate-stretch"></div>
        </div>
        <p class="text-xs text-slate-400 mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="px-3 pb-20 opacity-0 transition-opacity duration-500">
        
        <!-- Filter Controls -->
        <div class="bg-white rounded-xl p-4 card-shadow mb-4 flex flex-wrap gap-2 justify-center">
            <button class="filter-btn active" data-cat="isMV">MV</button>
            <button class="filter-btn active" data-cat="isFullOther">Live</button>
            <button class="filter-btn active" data-cat="isNYMovie">New Year</button>
            <button class="filter-btn active" data-cat="isOther">ãã®ä»–</button>
        </div>

        <p class="text-center text-xs text-slate-500 mb-4">é …ç›®åã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ä¸¦ã³æ›¿ãˆã§ãã‚‹ã‚ˆ</p>

        <!-- Data Table -->
        <div class="bg-white rounded-xl overflow-hidden card-shadow relative">
            <div id="update-time" class="absolute top-2 right-3 text-[10px] text-slate-400 font-mono"></div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                        <tr>
                            <th class="p-3 text-center w-8">#</th>
                            <th class="p-3 min-w-[120px]">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th class="p-3 text-right cursor-pointer sortable-th desc" data-key="totalViews">è¦–è´å›æ•°</th>
                            <th class="p-3 text-center cursor-pointer sortable-th" data-key="publishedDate">å…¬é–‹æ—¥</th>
                            <th class="p-3 text-right cursor-pointer sortable-th" data-key="avgDailyViews">å¹³å‡/æ—¥<br><span class="text-[10px] font-normal">(å…¨æœŸé–“)</span></th>
                            <th class="p-3 text-right cursor-pointer sortable-th" data-key="avgViews7Days">å¹³å‡/æ—¥<br><span class="text-[10px] font-normal">(ç›´è¿‘7æ—¥)</span></th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        <!-- JSã§ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-slate-400 text-xs">
            <p class="mb-2">Produced with ğŸ’™</p>
            <a href="https://lit.link/nokidochibi" target="_blank" class="underline hover:text-slate-600">nokidochibi</a>
        </div>
    </main>

    <!-- Graph Modal -->
    <div id="graph-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeGraphModal()">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeGraphModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 id="graph-title" class="text-lg font-bold text-slate-700 mb-4 pr-8 leading-tight"></h3>
            <div class="h-64 w-full relative">
                <canvas id="dailyViewsChart"></canvas>
                <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 text-slate-500 text-sm">
                    ã‚°ãƒ©ãƒ•ä½œæˆä¸­...ğŸŒ±
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // è¨­å®š: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®GAS API URLã‚’ä½¿ç”¨
        const GAS_API_URL = parent.GAS_API_URL || "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
        
        let allData = [];
        let filteredData = [];
        let sortKey = 'totalViews';
        let sortDesc = true;
        let chartInstance = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initFilterButtons();
            initSortHeaders();
            fetchData();
        });

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³åˆ¶å¾¡
        function initFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                // åˆæœŸã‚¹ã‚¿ã‚¤ãƒ«
                updateFilterBtnStyle(btn);
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    updateFilterBtnStyle(btn);
                    applyFilterAndRender();
                });
            });
        }

        function updateFilterBtnStyle(btn) {
            if (btn.classList.contains('active')) {
                btn.className = 'filter-btn active px-3 py-1.5 rounded-full text-xs font-bold border transition-colors bg-blue-500 text-white border-blue-600';
            } else {
                btn.className = 'filter-btn px-3 py-1.5 rounded-full text-xs font-bold border transition-colors bg-white text-slate-500 border-slate-200 hover:bg-slate-50';
            }
        }

        // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼åˆ¶å¾¡
        function initSortHeaders() {
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    if (sortKey === key) {
                        sortDesc = !sortDesc;
                    } else {
                        sortKey = key;
                        sortDesc = true; // æ–°ã—ã„ã‚­ãƒ¼ã¯é™é †ã‚¹ã‚¿ãƒ¼ãƒˆ
                    }
                    
                    // UIæ›´æ–°
                    document.querySelectorAll('.sortable-th').forEach(t => t.classList.remove('asc', 'desc', 'text-blue-600'));
                    th.classList.add(sortDesc ? 'desc' : 'asc');
                    th.classList.add('text-blue-600');
                    
                    renderTable();
                });
            });
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchData() {
            try {
                // GAS APIã‚’å©ã (action=getTrendsData)
                // â€» ç¾åœ¨ã®Code.gsã«ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å¾Œã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                const res = await fetch(`${GAS_API_URL}?action=getTrendsData`);
                const json = await res.json();

                if (json.status === 'error' || !json.data) {
                    throw new Error(json.message || 'ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                }

                allData = json.data;
                document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${json.lastUpdateTime || '-'}`;
                
                // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
                completeLoading(json.maxTotalViews || 1000000);
                
                // åˆå›æç”»
                applyFilterAndRender();

            } catch (err) {
                console.error(err);
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 text-sm">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>(${err.message})</p>`;
                // é–‹ç™ºç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆAPIæœªå®Ÿè£…æ™‚ã®ç¢ºèªç”¨ï¼‰
                // loadDummyData(); 
            }
        }

        function completeLoading(targetNum) {
            const el = document.getElementById('counting-number');
            let current = 0;
            const duration = 1000;
            const step = targetNum / (duration / 16);
            
            const timer = setInterval(() => {
                current += step;
                if (current >= targetNum) {
                    current = targetNum;
                    clearInterval(timer);
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('main-content').classList.remove('opacity-0');
                    }, 500);
                }
                el.textContent = Math.floor(current).toLocaleString();
            }, 16);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨æç”»
        function applyFilterAndRender() {
            const activeCats = Array.from(document.querySelectorAll('.filter-btn.active')).map(btn => btn.dataset.cat);
            
            filteredData = allData.filter(item => {
                // ã„ãšã‚Œã‹ã®æœ‰åŠ¹ãªã‚«ãƒ†ã‚´ãƒªãƒ•ãƒ©ã‚°ãŒ '1' ã§ã‚ã‚Œã°è¡¨ç¤º
                return activeCats.some(cat => item[cat] === '1' || item[cat] === 1);
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            // ã‚½ãƒ¼ãƒˆ
            filteredData.sort((a, b) => {
                let va = a[sortKey];
                let vb = b[sortKey];
                
                // æ—¥ä»˜å¯¾å¿œ
                if (sortKey === 'publishedDate') {
                    va = new Date(va).getTime();
                    vb = new Date(vb).getTime();
                } else if (typeof va === 'string') {
                    // æ•°å€¤ã‚’å«ã‚€æ–‡å­—åˆ—ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
                    va = parseFloat(va.replace(/,/g, '')) || 0;
                    vb = parseFloat(vb.replace(/,/g, '')) || 0;
                }

                return sortDesc ? vb - va : va - vb;
            });

            // HTMLç”Ÿæˆ
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // æœ€å¤§å€¤ã®è¨ˆç®—ï¼ˆã‚°ãƒ©ãƒ•ãƒãƒ¼ç”¨ï¼‰
            const maxViews = Math.max(...filteredData.map(d => parseFloat(d.totalViews) || 0));

            filteredData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';
                
                // è¦–è´å›æ•°ã‚°ãƒ©ãƒ•ãƒãƒ¼ã®å¹…
                const barWidth = ((parseFloat(item.totalViews) || 0) / maxViews) * 100;

                tr.innerHTML = `
                    <td class="p-3 text-center text-xs font-bold text-slate-400">${index + 1}</td>
                    <td class="p-3">
                        <a href="${item.url}" target="_blank" class="font-bold text-slate-700 hover:text-blue-500 text-sm block leading-tight mb-1">
                            ${item.title}
                        </a>
                    </td>
                    <td class="p-3 text-right">
                        <div class="flex flex-col items-end cursor-pointer" onclick="openGraph('${item.url}', '${item.title.replace(/'/g, "\\'")}')">
                            <span class="font-bold text-blue-600 text-sm">${Number(item.totalViews).toLocaleString()}</span>
                            <div class="w-20 h-1 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                <div class="h-full bg-blue-400" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="p-3 text-center text-xs text-slate-500 whitespace-nowrap">
                        ${item.publishedDate.split('T')[0].replace(/-/g, '/')}
                    </td>
                    <td class="p-3 text-right text-xs text-slate-600 font-mono">
                        ${Number(item.avgDailyViews).toLocaleString()}
                    </td>
                    <td class="p-3 text-right text-xs text-slate-600 font-mono">
                        ${item.avgViews7Days === '(é›†è¨ˆä¸­)' ? '<span class="text-orange-400 text-[10px]">é›†è¨ˆä¸­</span>' : Number(item.avgViews7Days).toLocaleString()}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        async function openGraph(url, title) {
            const modal = document.getElementById('graph-modal');
            const titleEl = document.getElementById('graph-title');
            const loading = document.getElementById('graph-loading');
            
            titleEl.textContent = title;
            modal.classList.remove('hidden');
            loading.style.display = 'flex';

            // ChartåˆæœŸåŒ–ãƒ»ç ´æ£„
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            try {
                // GAS APIã‹ã‚‰æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const res = await fetch(`${GAS_API_URL}?action=getTrendGraph&url=${encodeURIComponent(url)}`);
                const json = await res.json();
                
                loading.style.display = 'none';

                if (json.status === 'success' && json.data.length > 0) {
                    renderChart(json.data);
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãªã—è¡¨ç¤º
                    const ctx = document.getElementById('dailyViewsChart');
                    // ç°¡æ˜“çš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãªã©ã®å‡¦ç†
                }

            } catch (err) {
                console.error(err);
                loading.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼";
            }
        }

        function closeGraphModal() {
            document.getElementById('graph-modal').classList.add('hidden');
        }

        function renderChart(dailyData) {
            const ctx = document.getElementById('dailyViewsChart').getContext('2d');
            
            // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
            const labels = dailyData.map(d => d.date.substring(5)); // æœˆ/æ—¥
            const values = dailyData.map(d => d.views);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è¦–è´å›æ•°',
                        data: values,
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { borderDash: [2, 4] }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
