<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰º∏„Å≥„Çç!Êé®„ÅóaV</title>
    
    <!-- Chart.js & Icons -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tailwind (UtilityÁî®) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. Base & Theme Colors (Blue Theme)
           ========================================= */
        :root {
            --bg-color: #f0f9ff;       /* ÂÖÉ: #ffe0e0 */
            --header-bg: #f0f9ff;      /* ÂÖÉ: #ffe0e0 */
            --accent-color: #3b82f6;   /* ÂÖÉ: #d32f2f (Ëµ§) -> Èùí */
            --bar-color: #3b82f6;      /* ÂÖÉ: #ff9800 („Ç™„É¨„É≥„Ç∏) -> Èùí */
            --text-main: #334155;
            --border-color: #cbd5e1;
            --hover-bg: #e0f2fe;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif; /* „Éï„Ç©„É≥„Éà„ÅÆ„Åø„É¢„ÉÄ„É≥„Å´ */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(70px + env(safe-area-inset-bottom)); /* „Éï„ÉÉ„Çø„ÉºÂàÜÁ©∫„Åë„Çã */
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* =========================================
           2. GASÁâà„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÁßªÊ§ç (Layout & Table)
           ========================================= */
        h1 {
            text-align: center;
            color: var(--text-main);
            margin: 0;
            font-size: 2.2em; /* Â∞ë„ÅóË™øÊï¥ */
            background-color: var(--header-bg);
            padding: 40px 10px 10px 10px;
            box-sizing: border-box;
            width: 100%;
            font-weight: bold;
            letter-spacing: 0.1em;
            line-height: 1.2;
        }

        .loading-animation-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 0 10px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .counting-container {
            order: 1;
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
            justify-content: center;
        }
        .counting-number {
            font-size: 1.5em;
            color: var(--text-main);
            font-weight: bold;
        }
        .counting-unit {
            font-size: 0.9em;
            color: #64748b;
            margin-left: 5px;
        }
        .underline-container {
            width: 100%;
            height: 30px;
            margin: 5px auto 10px auto;
            overflow: hidden;
            position: relative;
            order: 2;
        }
        .underline-bar {
            height: 100%;
            width: 0;
            background-color: var(--bar-color);
            position: absolute;
            top: 0;
            left: 0;
            animation: stretch-to-end 3s ease-out forwards;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            box-sizing: border-box;
        }
        .loading-text {
            color: white;
            font-size: 0.8em;
            white-space: nowrap;
            font-weight: bold;
        }
        @keyframes stretch-to-end {
            0% { width: 0; }
            100% { width: 100%; }
        }

        .subtitle {
            text-align: center;
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 15px;
            display: block;
            padding: 0 10px;
            background-color: var(--bg-color);
        }

        /* „Éï„Ç£„É´„Çø„Éú„Çø„É≥ */
        .filter-controls {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 0 10px 15px 10px;
        }
        .filter-option {
            display: inline-block;
            padding: 6px 12px;
            border: 1px solid var(--accent-color);
            border-radius: 20px;
            background-color: white;
            color: var(--accent-color);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
        }
        .filter-option.selected {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .category-checkbox-hidden { display: none; }

        /* „ÉÜ„Éº„Éñ„É´„Ç≥„É≥„ÉÜ„Éä */
        .table-container {
            position: relative;
            margin: 0 5px;
            margin-top: 30px;
            box-sizing: border-box;
        }
        .update-time {
            position: absolute;
            top: -22px;
            right: 5px;
            font-size: 0.75em;
            color: #64748b;
            z-index: 2;
            font-family: monospace;
        }

        /* „ÉÜ„Éº„Éñ„É´„Çπ„Çø„Ç§„É´ */
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background-color: #fff;
            box-sizing: border-box;
            font-size: 1em;
            table-layout: fixed; /* ÈáçË¶Å: „Åì„Çå„Åå„Å™„ÅÑ„Å®ÂπÖÊåáÂÆö„ÅåÂäπ„Åã„Å™„ÅÑ */
            border-radius: 8px;
            overflow: hidden;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--header-bg);
            border-bottom: 2px solid #e2e8f0;
        }
        th, td {
            padding: 8px 2px;
            border-bottom: 1px solid #f1f5f9;
            word-break: break-word;
            white-space: normal;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background-color: var(--header-bg);
            color: #475569;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            line-height: 1.3;
            font-size: 0.85em;
        }
        th small { font-size: 0.8em; opacity: 0.8; }

        /* „ÇΩ„Éº„Éà„Ç¢„Ç§„Ç≥„É≥ */
        .sortable th::after {
            content: ''; display: inline-block; vertical-align: middle; margin-left: 2px;
            width: 0; height: 0;
            border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid #cbd5e1;
        }
        .sortable th.asc::after {
            border-bottom: 4px solid var(--accent-color); border-top: none;
        }
        .sortable th.desc::after {
            border-top: 4px solid var(--accent-color); border-bottom: none;
        }

        /* =========================================
           ‚òÖ ÂàóÂπÖË®≠ÂÆö (User's Favorite Layout)
           ========================================= */
        
        /* PC (>= 769px) */
        @media (min-width: 769px) {
            th:nth-child(1), td:nth-child(1) { width: 4%; text-align: center; font-weight: bold; color: #94a3b8; }
            th:nth-child(2), td:nth-child(2) { width: 41%; text-align: left; padding-right: 15px; }
            th:nth-child(3), td:nth-child(3) { width: 15%; text-align: right; font-weight: bold; padding: 0 10px; font-size: 1.1em; }
            th:nth-child(4), td:nth-child(4) { width: 15%; text-align: center; }
            th:nth-child(5), td:nth-child(5) { width: 12.5%; text-align: right; }
            th:nth-child(6), td:nth-child(6) { width: 12.5%; text-align: right; }
        }

        /* Tablet (max 768px) */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; padding: 15px 5px; }
            .table-container { margin: 20px 2px 0 2px; }
            
            th:nth-child(1), td:nth-child(1) { width: 6%; text-align: center; font-weight: bold; color: #94a3b8; font-size: 0.8em; }
            th:nth-child(2), td:nth-child(2) { width: 34%; text-align: left; padding-right: 4px; line-height: 1.4; font-size: 0.9em; }
            th:nth-child(3), td:nth-child(3) { width: 20%; text-align: right; font-weight: bold; padding: 0 4px; font-size: 1em; white-space: nowrap; }
            th:nth-child(4), td:nth-child(4) { width: 15%; text-align: center; font-size: 0.8em; }
            th:nth-child(5), td:nth-child(5) { width: 12.5%; text-align: right; font-size: 0.85em; padding-right: 2px; }
            th:nth-child(6), td:nth-child(6) { width: 12.5%; text-align: right; font-size: 0.85em; padding-right: 2px; }
        }

        /* Mobile (max 480px) */
        @media (max-width: 480px) {
            th:nth-child(1), td:nth-child(1) { width: 8%; }
            th:nth-child(2), td:nth-child(2) { width: 30%; }
            th:nth-child(3), td:nth-child(3) { width: 22%; }
            th:nth-child(4), td:nth-child(4) { width: 14%; } /* ÂÖ¨ÈñãÊó• */
            th:nth-child(5), td:nth-child(5) { width: 13%; } /* Âπ≥Âùá */
            th:nth-child(6), td:nth-child(6) { width: 13%; } /* Áõ¥Ëøë */
            
            td { padding: 4px 1px; font-size: 0.85em; }
            th { padding: 4px 1px; font-size: 0.75em; }
        }

        /* „Çª„É´ÂÜÖË£ÖÈ£æ */
        a { color: var(--text-main); text-decoration: none; display: block; }
        a small { color: #64748b; font-size: 0.85em; display: block; margin-top: 1px; }
        
        .views-number {
            display: block;
            color: var(--accent-color);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: rgba(59, 130, 246, 0.3);
        }
        .views-graph-container {
            width: 100%; height: 4px; background-color: #f1f5f9; border-radius: 2px; margin-top: 2px; overflow: hidden;
        }
        .views-graph-bar {
            height: 100%; background-color: var(--bar-color); width: 0; transition: width 0.5s ease-out;
        }
        .emoji-number-container {
            display: flex; flex-direction: column; align-items: center; line-height: 1.1;
        }
        .emoji { font-size: 1.2em; margin-bottom: 1px; }

        /* =========================================
           3. UI Components (Modal, Footer, Tabs)
           ========================================= */
        
        /* „Éï„ÉÉ„Çø„Éº„Éä„Éì */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: white; border-top: 1px solid #e2e8f0;
            z-index: 50; display: flex;
            height: calc(60px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.03);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 4px; color: #94a3b8; cursor: pointer; transition: all 0.2s;
        }
        .nav-item.active {
            color: var(--accent-color); background-color: #eff6ff;
        }
        
        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÂà∂Âæ° */
        .tab-content { display: none; padding-bottom: 20px; }
        .tab-content.active { display: block; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            padding-top: 60px;
            align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background-color: #fff; margin: auto; padding: 20px;
            border: 1px solid #e2e8f0; width: 90%; max-width: 600px;
            border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .close {
            position: absolute; top: 10px; right: 15px;
            color: #94a3b8; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .graph-title {
            text-align: center; font-size: 1.1em; color: var(--text-main);
            margin-bottom: 20px; font-weight: bold; padding-right: 20px;
        }
        #loading, #error { text-align: center; padding: 20px; color: #64748b; font-size: 0.9em; }
        #error { color: #ef4444; }

        /* „Éï„Ç©„É≠„ÉØ„Éº„Ç∞„É©„ÉïÁî®„Çπ„Çø„Ç§„É´ */
        .follower-card {
            background: white; border-radius: 12px; padding: 16px;
            margin: 16px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <!-- Tab 1: „É©„É≥„Ç≠„É≥„Ç∞ (GASÁâàË∏èË•≤) -->
    <div id="tab-views" class="tab-content active">
        <h1>‰º∏„Å≥„Çç!Êé®„ÅóaV</h1>

        <!-- Loading Animation -->
        <div id="loadingAnimation" class="loading-animation-container">
            <div class="counting-container">
                <span id="countingNumber" class="counting-number">0</span><span class="counting-unit">ÂõûË¶ñËÅ¥</span>
            </div>
            <div class="underline-container">
                <div class="underline-bar">
                    <span class="loading-text">„Å≠„Åå„ÅÜÂ§ú</span>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="filter-controls">
            <span class="filter-option" data-category="isMV" data-checkbox-id="filterMV">MV</span>
            <input type="checkbox" class="category-checkbox-hidden" id="filterMV" data-category="isMV" checked>
            
            <span class="filter-option" data-category="isFullOther" data-checkbox-id="filterFullOther">Live</span>
            <input type="checkbox" class="category-checkbox-hidden" id="filterFullOther" data-category="isFullOther" checked>
            
            <span class="filter-option" data-category="isNYMovie" data-checkbox-id="filterNYMovie">new year</span>
            <input type="checkbox" class="category-checkbox-hidden" id="filterNYMovie" data-category="isNYMovie" checked>
            
            <span class="filter-option" data-category="isOther" data-checkbox-id="filterOther">‰ªñ(„Ç∑„Éß„Éº„ÉàÁ≠â)</span>
            <input type="checkbox" class="category-checkbox-hidden" id="filterOther" data-category="isOther" checked>
        </div>

        <span class="subtitle">„ÄåË¶ñËÅ¥ÂõûÊï∞„Äç„Å®„Åã„Çø„ÉÉ„Éó„Åó„Åü„ÇâÈ†ÜÁï™ÂÖ•„ÇåÊõø„Çè„Çã„Åß</span>
        <div id="error" style="display:none;"></div>

        <!-- Table -->
        <div class="table-container">
            <span id="lastUpdateTimeDisplay" class="update-time"></span>
            <table id="dataTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div style="text-align:center; padding: 20px; font-size:0.8em; color:#94a3b8;">
            <p>‚ÄªÂàóÂπÖ„Éª„É¨„Ç§„Ç¢„Ç¶„Éà„ÅØ„Ç™„É™„Ç∏„Éä„É´„ÇíË∏èË•≤„Åó„Å¶„ÅÑ„Åæ„Åô</p>
        </div>
    </div>

    <!-- Tab 2: „Éï„Ç©„É≠„ÉØ„Éº (New) -->
    <div id="tab-followers" class="tab-content">
        <h1 style="font-size: 1.5em; padding: 20px;">SNS„Éï„Ç©„É≠„ÉØ„ÉºÊé®Áßª</h1>
        
        <div class="follower-card">
            <h3 class="font-bold text-red-600 flex items-center gap-2 mb-4 text-base">
                <i data-lucide="youtube" class="w-5 h-5"></i> YoutubeÁôªÈå≤ËÄÖÊï∞
            </h3>
            <div style="height: 250px; position: relative;">
                <canvas id="chart-youtube"></canvas>
            </div>
        </div>

        <div class="follower-card">
            <h3 class="font-bold text-sky-500 flex items-center gap-2 mb-4 text-base">
                <i data-lucide="twitter" class="w-5 h-5"></i> Twitter„Éï„Ç©„É≠„ÉØ„ÉºÊï∞
            </h3>
            <div style="height: 250px; position: relative;">
                <canvas id="chart-twitter"></canvas>
            </div>
        </div>
        
        <p class="text-center text-xs text-slate-400 mt-4 mb-4">‚Äª „Éá„Éº„Çø„ÅØÊØéÊó•Ëá™ÂãïÊõ¥Êñ∞„Åï„Çå„Åæ„Åô</p>
    </div>

    <!-- Footer Nav -->
    <nav>
        <div onclick="switchTab('views')" class="nav-item active" id="nav-views">
            <i data-lucide="trending-up" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">YTË¶ñËÅ¥ÂõûÊï∞</span>
        </div>
        <div onclick="switchTab('followers')" class="nav-item" id="nav-followers">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">„Éï„Ç©„É≠„ÉØ„Éº</span>
        </div>
    </nav>

    <!-- Modal -->
    <div id="graphModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGraphModal()">&times;</span>
            <h2 id="graphTitle" class="graph-title"></h2>
            <div id="graphLoading" style="text-align:center; padding:20px; color:#64748b;">„Ç∞„É©„Éï‰ΩúÊàê‰∏≠...üå±üåøüå≥</div>
            <div style="position: relative; height: 300px; width:100%;">
                <canvas id="dailyViewsChart" style="display: none;"></canvas>
            </div>
            <div id="noGraphData" style="text-align:center; display: none; padding:20px; color:#94a3b8;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
    </div>

<script>
    // ==========================================
    // 0. CONFIG & STATE
    // ==========================================
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
    
    let videoData = [];
    let filteredVideoData = [];
    let tableHeaders = [];
    let maxTotalViews = 0;
    let currentSortColumn = 'totalViews';
    let currentSortDirection = 'desc';
    let followersDataLoaded = false;

    // Animation vars
    const countingNumberElement = document.getElementById('countingNumber');
    const loadingAnimationDiv = document.getElementById('loadingAnimation');
    let animationFrameId = null;
    let currentCount = 0;
    let animationStartTime = null;
    let dailyViewsChartInstance = null;

    // ==========================================
    // 1. INIT
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        animateCountingNumber(1874093, 3000, 0, false); // Start fake loading
        fetchData(); // Get data
        
        // Filter Click Events
        document.querySelectorAll('.filter-option').forEach(span => {
            const checkboxId = span.dataset.checkboxId;
            const checkbox = document.getElementById(checkboxId);
            if(checkbox.checked) span.classList.add('selected');
            
            span.addEventListener('click', () => {
                checkbox.checked = !checkbox.checked;
                span.classList.toggle('selected', checkbox.checked);
                filterAndDisplay();
            });
        });

        // Modal Outside Click
        window.addEventListener('click', (e) => {
            if(e.target === document.getElementById('graphModal')) closeGraphModal();
        });
    });

    // ==========================================
    // 2. TAB CONTROL
    // ==========================================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-' + tabName).classList.add('active');
        
        if (tabName === 'followers' && !followersDataLoaded) {
            fetchFollowersData();
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==========================================
    // 3. RANKING LOGIC (from GAS)
    // ==========================================
    async function fetchData() {
        try {
            const res = await fetch(`${GAS_API_URL}?action=getTrendsData`);
            const json = await res.json();
            
            if (json.status === 'error') throw new Error(json.message);

            // Data Adapter for GAS logic
            const adaptedData = {
                headers: [
                    { text: 'YouTube<br>ÂãïÁîª„Çø„Ç§„Éà„É´', key: 'title', type: 'string' },
                    { text: 'Ë¶ñËÅ¥ÂõûÊï∞', key: 'totalViews', type: 'number' },
                    { text: 'ÂÖ¨ÈñãÊó•', key: 'publishedDate', type: 'date' },
                    { text: 'Âπ≥Âùá/Êó•<br><small>(ÂÖ®ÊúüÈñì)</small>', key: 'avgDailyViews', type: 'number' },
                    { text: 'Âπ≥Âùá/Êó•<br><small>(ÈÅéÂéª7Êó•)</small>', key: 'avgViews7Days', type: 'number' }
                ],
                data: json.data.map(item => ({
                    ...item,
                    totalViews: parseFloat(item.totalViews) || 0,
                    avgDailyViews: parseFloat(item.avgDailyViews) || 0,
                    avgViews7Days: (item.avgViews7Days === "(ÈõÜË®à‰∏≠)" ? item.avgViews7Days : parseFloat(item.avgViews7Days) || 0)
                })),
                maxLoadingCount: json.maxTotalViews || 2000000,
                maxTotalViews: json.maxTotalViews || 0,
                lastUpdateTime: json.lastUpdateTime || ''
            };

            displayData(adaptedData);

        } catch (e) {
            document.getElementById('error').textContent = e.message;
            document.getElementById('error').style.display = 'block';
            loadingAnimationDiv.style.display = 'none';
        }
    }

    function displayData(data) {
        videoData = data.data;
        tableHeaders = data.headers;
        maxTotalViews = data.maxTotalViews;

        // Header Generation
        const thead = document.getElementById('tableHeader');
        thead.innerHTML = '<th style="cursor:default">#</th>';
        tableHeaders.forEach(h => {
            const th = document.createElement('th');
            th.innerHTML = h.text;
            if(h.key !== 'url') {
                th.classList.add('sortable');
                th.onclick = () => {
                    const dir = (currentSortColumn === h.key && currentSortDirection === 'asc') ? 'desc' :
                                (currentSortColumn === h.key && currentSortDirection === 'desc') ? 'asc' :
                                (h.key === 'publishedDate') ? 'asc' : 'desc';
                    sortTable(h.key, h.type, dir);
                };
            }
            thead.appendChild(th);
        });

        if(data.lastUpdateTime) {
            document.getElementById('lastUpdateTimeDisplay').textContent = `‚Äª${data.lastUpdateTime}Êõ¥Êñ∞`;
            document.getElementById('lastUpdateTimeDisplay').style.display = 'block';
        }

        // Finish Animation
        animateCountingNumber(data.maxLoadingCount, 1000, currentCount, true);
        
        filterAndDisplay(true);
    }

    function filterAndDisplay(isInit = false) {
        const checked = Array.from(document.querySelectorAll('.category-checkbox-hidden:checked')).map(c => c.dataset.category);
        
        if (checked.length === 0) {
            filteredVideoData = [];
        } else {
            filteredVideoData = videoData.filter(v => checked.some(c => v[c] === '1' || v[c] === 1));
        }

        if (isInit) {
            const h = tableHeaders.find(h => h.key === currentSortColumn);
            if(h) sortTable(currentSortColumn, h.type, currentSortDirection);
            else updateTableBody(filteredVideoData);
        } else {
            updateTableBody(filteredVideoData);
        }
    }

    function sortTable(key, type, dir) {
        currentSortColumn = key;
        currentSortDirection = dir;
        
        // Update Icons
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            // Simplified check based on innerHTML content match is risky, 
            // but for now relying on index order is safer or data attr
        });
        // Re-render headers to update sort class (lazy way) or iterate
        const ths = document.getElementById('tableHeader').children;
        for(let i=1; i<ths.length; i++) { // skip #
            if(tableHeaders[i-1].key === key) ths[i].classList.add(dir);
        }

        const sorted = [...filteredVideoData].sort((a, b) => {
            let va = a[key], vb = b[key];
            if(type === 'number') return dir === 'asc' ? (parseFloat(va)||0)-(parseFloat(vb)||0) : (parseFloat(vb)||0)-(parseFloat(va)||0);
            if(type === 'date') {
                const da = new Date(va).getTime() || (dir==='asc'?-Infinity:Infinity);
                const db = new Date(vb).getTime() || (dir==='asc'?-Infinity:Infinity);
                return dir === 'asc' ? da - db : db - da;
            }
            return dir === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
        updateTableBody(sorted);
    }

    function updateTableBody(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${tableHeaders.length+1}" style="text-align:center; padding:20px; color:#94a3b8;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>`;
            return;
        }

        // Calculate Max for Emojis
        const maxDaily = Math.max(...data.map(d => parseFloat(d.avgDailyViews)||0));
        const max7Days = Math.max(...data.map(d => parseFloat(d.avgViews7Days)||0));

        data.forEach((row, i) => {
            const tr = document.createElement('tr');
            
            // #
            tr.innerHTML += `<td style="text-align:center; font-weight:bold; color:#94a3b8;">${i+1}</td>`;
            
            // Cells
            tableHeaders.forEach(h => {
                let td = document.createElement('td');
                const val = row[h.key];
                
                if (h.key === 'title') {
                    td.innerHTML = `<a href="${row.url}" target="_blank">${formatTitle(val)}</a>`;
                } else if (h.key === 'totalViews') {
                    const num = parseFloat(val)||0;
                    const pct = (maxTotalViews > 0) ? (num / maxTotalViews * 100) : 0;
                    td.innerHTML = `
                        <span class="views-number" onclick="openGraph('${row.url}', '${row.title.replace(/'/g,"\\'")}')">${num.toLocaleString()}</span>
                        <div class="views-graph-container"><div class="views-graph-bar" style="width:${pct}%"></div></div>
                    `;
                } else if (h.key === 'publishedDate') {
                    const d = new Date(val);
                    td.innerHTML = !isNaN(d.getTime()) ? `<strong>${d.getFullYear()}Âπ¥</strong><br><small>${d.getMonth()+1}Êúà${d.getDate()}Êó•</small>` : '';
                    td.style.textAlign = 'center';
                } else if (h.key.includes('avg')) {
                    const num = parseFloat(val)||0;
                    let emoji = '';
                    if (h.key === 'avgDailyViews' && num === maxDaily && num > 0) emoji = 'üëë';
                    if (h.key === 'avgViews7Days' && num === max7Days && num > 0) emoji = 'üî•';
                    if (val === "(ÈõÜË®à‰∏≠)") {
                        td.innerHTML = `<span style="font-size:0.8em; color:#94a3b8;">(ÈõÜË®à‰∏≠)</span>`;
                    } else {
                        td.innerHTML = `<div class="emoji-number-container">${emoji ? `<div class="emoji">${emoji}</div>` : ''}<span class="number-value">${Math.round(num).toLocaleString()}</span></div>`;
                    }
                    td.style.textAlign = 'right';
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    // ==========================================
    // 4. GRAPH & FOLLOWERS
    // ==========================================
    async function openGraph(url, title) {
        document.getElementById('graphModal').classList.add('open');
        document.getElementById('graphTitle').textContent = title;
        document.getElementById('graphLoading').style.display = 'block';
        document.getElementById('dailyViewsChart').style.display = 'none';
        
        if(dailyViewsChartInstance) { dailyViewsChartInstance.destroy(); dailyViewsChartInstance = null; }

        try {
            const res = await fetch(`${GAS_API_URL}?action=getTrendGraph&url=${encodeURIComponent(url)}`);
            const json = await res.json();
            
            document.getElementById('graphLoading').style.display = 'none';
            
            if(json.status === 'success' && json.data.length > 0) {
                document.getElementById('dailyViewsChart').style.display = 'block';
                renderGraph(json.data);
            } else {
                document.getElementById('noGraphData').style.display = 'block';
            }
        } catch(e) {
            document.getElementById('graphLoading').textContent = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
        }
    }

    function renderGraph(data) {
        const ctx = document.getElementById('dailyViewsChart').getContext('2d');
        dailyViewsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date.substring(5)),
                datasets: [{
                    label: 'Ë¶ñËÅ¥ÂõûÊï∞',
                    data: data.map(d => d.views),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true, tension: 0.2, pointRadius: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { ticks: { maxTicksLimit: 6 } } }
            }
        });
    }

    async function fetchFollowersData() {
        try {
            const res = await fetch(`${GAS_API_URL}?action=getFollowersHistory`);
            const json = await res.json();
            if (json.status === 'success') {
                renderFollowerChart('chart-youtube', json.data, 'youtube', '#ef4444');
                renderFollowerChart('chart-twitter', json.data, 'twitter', '#0ea5e9');
                followersDataLoaded = true;
            }
        } catch (e) { console.error(e); }
    }

    function renderFollowerChart(id, data, key, color) {
        const ctx = document.getElementById(id).getContext('2d');
        const valid = data.filter(d => d[key] !== null);
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: valid.map(d => d.date.substring(5)),
                datasets: [{
                    data: valid.map(d => d[key]),
                    borderColor: color, backgroundColor: color+'10',
                    borderWidth: 2, fill: true, pointRadius: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { ticks: { maxTicksLimit: 6 } } }
            }
        });
    }

    // ==========================================
    // 5. UTILS
    // ==========================================
    function animateCountingNumber(target, duration, start, isFinal) {
        const startTime = performance.now();
        const initial = start;
        
        function update(now) {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            if (!isDataLoaded && elapsed < 3000) {
                currentCount = Math.floor(initial + (target - initial) * progress);
                countingNumberElement.textContent = currentCount.toLocaleString();
                animationFrameId = requestAnimationFrame(update);
            } else if (!isDataLoaded) {
                // Random walk while waiting
                currentCount = Math.floor(Math.random() * 50000) + 1800000;
                countingNumberElement.textContent = currentCount.toLocaleString();
                animationFrameId = requestAnimationFrame(update);
            } else if (progress < 1) {
                currentCount = Math.floor(initial + (target - initial) * progress);
                countingNumberElement.textContent = currentCount.toLocaleString();
                animationFrameId = requestAnimationFrame(update);
            } else {
                currentCount = target;
                countingNumberElement.textContent = currentCount.toLocaleString();
                loadingAnimationDiv.style.display = 'none';
            }
        }
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(update);
    }

    function closeGraphModal() {
        document.getElementById('graphModal').classList.remove('open');
        document.getElementById('noGraphData').style.display = 'none';
    }

    function formatTitle(title) {
        // Original logic for „Äé„Äè brackets formatting
        const match = title.match(/[„Äå„Äé]/);
        if (match) {
            const idx = match.index;
            const pre = title.substring(0, idx);
            const post = title.substring(idx);
            const fmtPost = post.replace(/([„Äå„Äé][^„Äç„Äè]+[„Äç„Äè])/g, '<strong>$1</strong>');
            return `<small>${pre}</small><br>${fmtPost}`;
        }
        return `<small>${title}</small>`;
    }
</script>
</body>
</html>
