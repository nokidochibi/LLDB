<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Love Like DataBase Unified</title>
<meta name="theme-color" content="#ef4444">

<!-- ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
<link id="app-icon" rel="icon" type="image/png" href="icon_live.png">
<link id="apple-touch-icon" rel="apple-touch-icon" href="icon_live.png">
<link id="manifest-link" rel="manifest" href='data:application/manifest+json,{"name":"Love Like DataBase","short_name":"LLDB","start_url":".","display":"standalone","background_color":"#F8F8F8","theme_color":"#ef4444","icons":[{"src":"icon_live.png","sizes":"192x192 512x512","type":"image/png"}]}'>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
    :root { 
        --app-music: #f97316; --app-live: #ef4444; --app-history: #ec4899; --app-stats: #0f172a;
        --bg-color: #F8F8F8; --card-shadow: 0 2px 5px rgba(0,0,0,0.08);
        --aiko-pink: #FF69B4; --aiko-red: #ef4444; --aiko-yellow: #FFD700; --aiko-blue: #00BFFF;
    }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", sans-serif;
        background-color: var(--bg-color); color: #374151; 
        min-height: 100vh; overflow: hidden; touch-action: pan-y pinch-zoom; -webkit-tap-highlight-color: transparent;
    }

    /* ã‚¢ãƒ—ãƒªç”»é¢åŸºæœ¬è¨­å®š */
    .app-screen { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: white; display: none; flex-direction: column; 
        overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
        padding-top: 60px; padding-bottom: calc(70px + env(safe-area-inset-bottom));
    }
    .app-screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    header { height: 60px; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.3s; }
    #noren-menu {
        position: fixed; top: 60px; left: 0; width: 100%;
        background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); z-index: 90;
        transform: translateY(-120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    }
    #noren-menu.open { transform: translateY(0); }
    #noren-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 80; display: none; }

    /* å„ã‚¢ãƒ—ãƒªå›ºæœ‰ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ */
    .bottom-nav { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: white; border-top: 1px solid #eee; 
        display: none; height: calc(64px + env(safe-area-inset-bottom));
        padding-bottom: env(safe-area-inset-bottom); z-index: 50;
    }
    .bottom-nav.active { display: flex; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: #9CA3AF; font-size: 10px; font-weight: bold; cursor: pointer; }
    .nav-item.active { color: var(--active-color, #ef4444); }

    /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ */
    #live-detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 110; overflow-y: auto; padding-top: 60px; display: none; animation: slideIn 0.2s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* å…±é€šUIãƒ‘ãƒ¼ãƒ„ */
    .card-base { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 12px; }
    .bubble { border-radius: 1.2rem; padding: 12px 16px; max-width: 85%; font-size: 14px; margin-bottom: 12px; position: relative; line-height: 1.6; }
    .bubble.bot { background: white; border: 1px solid #e5e7eb; border-top-left-radius: 4px; margin-left: 44px; }
    .bubble.user { background: var(--app-music); color: white; border-top-right-radius: 4px; align-self: flex-end; margin-left: auto; }
    .bot-icon { width: 36px; height: 36px; border-radius: 50%; position: absolute; left: 0; top: 0; border: 1px solid #eee; }

    /* LLDB live å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .live-card-label { position: absolute; top: 12px; right: 12px; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 99px; color: white; }
    .live-card-label.pop { background: var(--aiko-pink); }
    .live-card-label.rock { background: var(--aiko-blue); }
    .live-card-label.aloha { background: var(--aiko-yellow); color: #333; }
    
    /* è»Œè·¡ã‚°ãƒªãƒƒãƒ‰ */
    .history-row { display: grid; grid-template-columns: 48px 1fr 1fr 1fr; border-bottom: 1px dashed #eee; min-height: 44px; }
    .history-row.year-start { border-top: 2px solid #ddd; }
    .col-date { font-size: 10px; color: #999; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; background: #fafafa; border-right: 1px solid #eee; }
    .event-chip { font-size: 9px; font-weight: bold; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; text-align: center; }
    .event-chip.live { background: white; color: #ef4444; border: 1px solid #ef4444; }
    .event-chip.single { background: #e0f2fe; color: #0284c7; }
    .event-chip.album { background: #fef9c3; color: #854d0e; }

    /* æš—é»’ãƒ¢ãƒ¼ãƒ‰ï¼ˆã—ã‚Šã¨ã‚Šç”¨ï¼‰ */
    body.dark-mode { background: #0f172a; color: #e2e8f0; }
    body.dark-mode .app-screen { background: #0f172a; }
    body.dark-mode header, body.dark-mode .bottom-nav { background: #1e293b; border-color: #334155; }
    body.dark-mode .bubble.bot { background: #334155; border-color: #475569; color: white; }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .pulse-text { animation: pulse 1.5s infinite; }
    @keyframes pulse { 50% { opacity: .5; } }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 20px; padding: 24px; width: 90%; max-width: 400px; position: relative; }
</style>
</head>
<body class="theme-live">

<!-- æš–ç°¾ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="noren-overlay" onclick="toggleNoren()"></div>
<div id="noren-menu">
    <div class="flex flex-col p-2">
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('music')">
            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="music"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB phrase</div><div class="text-xs text-gray-400">æ­Œè© / æ¥½æ›²æ¤œç´¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('live')">
            <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="mic-2"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB live</div><div class="text-xs text-gray-400">ãƒ©ã‚¤ãƒ– / ã‚»ãƒˆãƒªæ¤œç´¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('history')">
            <div class="w-10 h-10 bg-pink-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="heart-handshake"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB history</div><div class="text-xs text-gray-400">aikoã¨è‡ªåˆ† / å¹´è¡¨</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('stats')">
            <div class="w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center text-white"><i data-lucide="bar-chart-2"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB stats</div><div class="text-xs text-gray-400">äººæ°—ã®aiko / çµ±è¨ˆ</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4" onclick="showAboutModal()">
            <div class="w-10 h-10 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500"><i data-lucide="info"></i></div>
            <div class="flex-1"><div class="font-bold">About</div><div class="text-xs text-gray-400">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div></div>
        </div>
    </div>
    <div class="py-2 flex justify-center cursor-pointer" onclick="toggleNoren()">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
    </div>
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header id="main-header" class="bg-red-500 text-white transition-colors duration-300">
    <div class="flex items-center gap-2">
        <button id="header-back-btn" class="hidden p-1" onclick="closeLiveDetail()"><i data-lucide="arrow-left"></i></button>
        <h1 class="font-bold text-lg" id="header-title" ondblclick="activateSecretMode()">LLDB live</h1>
    </div>
    <div class="flex items-center gap-1">
        <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã‚¿ã‚° -->
        <span id="header-version-display" class="text-[10px] font-mono opacity-60 bg-white/20 px-1.5 py-0.5 rounded"></span>
        <button onclick="toggleNoren()" class="p-2"><i data-lucide="menu"></i></button>
    </div>
</header>

<!-- ============================================
     1. LLDB phrase (Music App)
     ============================================ -->
<div id="app-music" class="app-screen">
    <div id="music-chat-container" class="flex-1 p-4 overflow-y-auto bg-orange-50/30">
        <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ -->
    </div>
    <!-- phraseç”¨ã‚¿ãƒ– -->
    <div class="flex w-full bg-white border-t border-gray-100 sticky bottom-0">
        <button onclick="switchPhraseTab('lyrics')" id="phrase-tab-lyrics" class="flex-1 py-3 text-sm font-bold text-orange-500 border-t-2 border-orange-500">æ­Œè©</button>
        <button onclick="switchPhraseTab('title')" id="phrase-tab-title" class="flex-1 py-3 text-sm font-bold text-gray-400">æ¥½æ›²</button>
    </div>
    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="p-3 bg-white border-t border-gray-100">
        <form id="music-form" class="flex gap-2">
            <input type="text" id="music-input" placeholder="ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none">
            <button type="submit" class="bg-orange-500 text-white p-2 rounded-full"><i data-lucide="send" class="w-5 h-5"></i></button>
        </form>
    </div>
</div>

<!-- ============================================
     2. LLDB live (Live App)
     ============================================ -->
<div id="app-live" class="app-screen">
    <div id="live-content-container" class="p-4">
        <div id="live-tab-search" class="live-sub-content">
            <div class="card-base bg-gray-50 border border-gray-200 mb-4">
                <input type="text" id="live-search-input" placeholder="ãƒ©ã‚¤ãƒ–åãƒ»ä¼šå ´ãƒ»å¹´ã§æ¤œç´¢" class="w-full bg-white border rounded p-2 text-sm mb-2">
                <div class="flex gap-2">
                    <select id="tour-select" class="flex-1 text-xs p-1 border rounded"><option value="">ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–</option></select>
                    <select id="year-select" class="flex-1 text-xs p-1 border rounded"><option value="">ã™ã¹ã¦ã®å¹´</option></select>
                </div>
            </div>
            <div id="live-list" class="space-y-3"></div>
        </div>

        <div id="live-tab-history" class="live-sub-content hidden">
            <div id="history-grid" class="history-grid-container bg-white"></div>
        </div>
    </div>
</div>

<!-- ============================================
     3. LLDB history (Placeholder)
     ============================================ -->
<div id="app-history" class="app-screen">
    <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center text-pink-500 mb-4">
            <i data-lucide="heart-handshake" class="w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-bold text-pink-600 mb-2">Coming Soon?</h2>
        <p class="text-gray-400 text-sm">aikoã¨ã‚ãªãŸã®æ­´å²ã‚’é‡ã­ã‚‹æ©Ÿèƒ½ã‚’æº–å‚™ä¸­ã§ã™ğŸŒ·</p>
    </div>
</div>

<!-- ============================================
     4. LLDB stats (Placeholder)
     ============================================ -->
<div id="app-stats" class="app-screen">
    <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 mb-4">
            <i data-lucide="bar-chart-2" class="w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-700 mb-2">Coming Soon?</h2>
        <p class="text-gray-400 text-sm">YouTubeã®å†ç”Ÿæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã®çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆä¸­ã§ã™ğŸ“ˆ</p>
    </div>
</div>

<!-- ãƒ©ã‚¤ãƒ–è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
<div id="live-detail-view">
    <div class="p-4">
        <div class="card-base border-l-4 border-pink-500">
            <p id="detail-date" class="text-xs text-gray-400"></p>
            <h2 id="detail-title" class="font-bold text-xl text-red-500"></h2>
            <p id="detail-venue" class="text-sm font-bold"></p>
        </div>
        <h3 class="font-bold mb-2">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
        <div id="detail-setlist" class="card-base"></div>
    </div>
</div>

<!-- About ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="about-modal" class="modal-overlay" onclick="closeAboutModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-lg">About App</h2>
            <button onclick="closeAboutModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-500 mx-auto mb-3">
                <i data-lucide="heart" class="w-8 h-8 fill-current"></i>
            </div>
            <p class="font-bold text-gray-800">Love Like DataBase</p>
            <p id="about-version-display" class="text-[10px] text-gray-400"></p>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600 leading-relaxed mb-6">
            ã“ã®ã‚¢ãƒ—ãƒªã¯ï¼‘aikoãƒ•ã‚¡ãƒ³ã«ã‚ˆã‚‹éå…¬å¼ãªã‚¢ãƒ—ãƒªã§ã™ã€‚aikoã•ã‚“ã®æ¥½æ›²ã‚„ãƒ©ã‚¤ãƒ–ã®æ­´å²ã‚’ã€æ¥½ã—ã¿ãªãŒã‚‰æ¤œç´¢ã§ãã‚‹ã‚ˆã†åˆ¶ä½œã—ã¦ã„ã¾ã™ã€‚
        </div>
        <div class="flex items-center justify-between text-xs border-t border-gray-100 pt-4">
            <span class="text-gray-400">Developed by <span class="font-bold text-gray-600">ã®ãğŸŒ³</span></span>
            <a href="https://twitter.com/noki_dochibi" target="_blank" class="text-blue-400 font-bold hover:underline">@noki_dochibi</a>
        </div>
    </div>
</div>

<!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (Live Appç”¨) -->
<nav id="live-nav" class="bottom-nav">
    <div class="nav-item active" onclick="switchLiveTab('search')"><i data-lucide="calendar-days"></i><span>å…¬æ¼”</span></div>
    <div class="nav-item" onclick="switchLiveTab('song')"><i data-lucide="music"></i><span>æ¥½æ›²</span></div>
    <div class="nav-item" onclick="switchLiveTab('venue')"><i data-lucide="map-pin"></i><span>å ´æ‰€</span></div>
    <div class="nav-item" onclick="switchLiveTab('history')"><i data-lucide="footprints"></i><span>è»Œè·¡</span></div>
</nav>

<script>
    // --- â˜…å®šæ•°ãƒ»çŠ¶æ…‹ç®¡ç†â˜… ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
    const VERSION = "v5.1.1";
    let allData = { liveRecords: [], songData: {}, historyData: [] };
    let currentApp = 'live';
    let currentPhraseMode = 'lyrics';
    let isDarkMode = false;

    // --- åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã®åæ˜ 
        const headerVer = document.getElementById('header-version-display');
        const aboutVer = document.getElementById('about-version-display');
        if (headerVer) headerVer.textContent = VERSION;
        if (aboutVer) aboutVer.textContent = `Unified Version ${VERSION}`;

        loadData();
        switchApp('live');
        setupEventListeners();
    });

    async function loadData() {
        try {
            const response = await fetch(`${GAS_API_URL}?action=getAllData`);
            const data = await response.json();
            if (data.status === 'success') {
                allData = data;
                renderLiveList(allData.liveRecords);
                renderHistory();
                populateFilters();
            }
        } catch (e) { console.error("Data load failed", e); }
    }

    // --- ã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆ (æš–ç°¾) ---
    function switchApp(appName) {
        currentApp = appName;
        document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(`app-${appName}`);
        if (target) target.classList.add('active');
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ†ãƒ¼ãƒåˆ¶å¾¡
        const header = document.getElementById('main-header');
        const title = document.getElementById('header-title');
        const nav = document.getElementById('live-nav');
        
        // åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ
        nav.classList.remove('active');
        document.body.classList.remove('dark-mode');

        if (appName === 'live') {
            header.className = "bg-red-500 text-white";
            title.textContent = "LLDB live";
            nav.classList.add('active');
            document.documentElement.style.setProperty('--active-color', '#ef4444');
        } else if (appName === 'music') {
            header.className = "bg-orange-500 text-white";
            title.textContent = "LLDB phrase";
            document.documentElement.style.setProperty('--active-color', '#f97316');
        } else if (appName === 'history') {
            header.className = "bg-pink-500 text-white";
            title.textContent = "LLDB history";
        } else if (appName === 'stats') {
            header.className = "bg-slate-900 text-white";
            title.textContent = "LLDB stats";
        }
        
        toggleNoren(false);
    }

    // --- LLDB live ãƒ­ã‚¸ãƒƒã‚¯ ---
    function switchLiveTab(tabName) {
        document.querySelectorAll('.live-sub-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`live-tab-${tabName}`).classList.remove('hidden');
        document.querySelectorAll('#live-nav .nav-item').forEach(i => i.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
    }

    function renderLiveList(records) {
        const container = document.getElementById('live-list');
        if (!container) return;
        container.innerHTML = records.sort((a,b) => new Date(b.date) - new Date(a.date)).map(rec => `
            <div class="card-base relative overflow-hidden" onclick="openLiveDetail('${rec.date}', '${rec.tourName.replace(/'/g, "\\'")}')">
                <div class="live-card-label ${getLabelClass(rec.tourName)}">${getLabelText(rec.tourName)}</div>
                <p class="text-xs text-gray-400">${rec.date} (${rec.dayOfWeek})</p>
                <p class="font-bold text-gray-800 leading-tight pr-12">${rec.tourName}</p>
                <p class="text-xs text-gray-500 mt-1">${rec.venue}</p>
            </div>
        `).join('');
    }

    function openLiveDetail(date, tourName) {
        const rec = allData.liveRecords.find(r => r.date === date && r.tourName === tourName);
        if (!rec) return;
        document.getElementById('detail-date').textContent = rec.date;
        document.getElementById('detail-title').textContent = rec.tourName;
        document.getElementById('detail-venue').textContent = rec.venue;
        
        let html = '';
        let num = 1;
        rec.setlist.forEach(s => {
            if (s === '__MEDLEY_START__') { html += `<div class="font-bold text-yellow-600 mt-2">ãƒ¡ãƒ‰ãƒ¬ãƒ¼</div>`; return; }
            if (s === '__MEDLEY_END__') return;
            html += `<div class="py-1 border-b border-gray-50 text-sm flex gap-2"><span class="text-gray-300 w-6">${num++}.</span>${s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '')}</div>`;
        });
        document.getElementById('detail-setlist').innerHTML = html;
        document.getElementById('live-detail-view').style.display = 'block';
        document.getElementById('header-back-btn').classList.remove('hidden');
    }

    function closeLiveDetail() {
        document.getElementById('live-detail-view').style.display = 'none';
        document.getElementById('header-back-btn').classList.add('hidden');
    }

    function renderHistory() {
        const container = document.getElementById('history-grid');
        if (!container) return;
        let html = '';
        let lastYear = '';
        allData.historyData.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(ev => {
            const year = ev.date.split('/')[0];
            const month = ev.date.split('/')[1];
            const rowClass = (year !== lastYear) ? 'year-start' : '';
            html += `
                <div class="history-row ${rowClass}">
                    <div class="col-date">${year !== lastYear ? `<span class="font-bold text-gray-800">${year}</span>` : ''} ${month}æœˆ</div>
                    <div class="p-1">${ev.type === 'live' ? `<div class="event-chip live">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'single' ? `<div class="event-chip single">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'album' ? `<div class="event-chip album">${ev.title}</div>` : ''}</div>
                </div>
            `;
            lastYear = year;
        });
        container.innerHTML = html;
    }

    // --- LLDB phrase ãƒ­ã‚¸ãƒƒã‚¯ ---
    async function handlePhraseSearch(e) {
        e.preventDefault();
        const query = document.getElementById('music-input').value.trim();
        if (!query) return;
        
        addMessage(query, 'user');
        document.getElementById('music-input').value = '';
        const loadingId = addLoading();

        const endpoint = currentPhraseMode === 'lyrics' ? 'searchLyrics' : 'searchTitleData';
        try {
            const res = await fetch(`${GAS_API_URL}?action=${endpoint}&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            removeLoading(loadingId);
            
            if (currentPhraseMode === 'lyrics') renderLyricsResults(data);
            else renderTitleResults(data);
        } catch (e) { addMessage("ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã¿ãŸã„...", "bot"); }
    }

    function activateSecretMode() {
        if (currentApp !== 'music') return;
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        if (isDarkMode) {
            addMessage("è£ãƒ¢ãƒ¼ãƒ‰ã€Œã—ã‚Šã¨ã‚Šã€èµ·å‹•ã€‚æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚", "bot");
            currentPhraseMode = 'shiritori';
        } else {
            currentPhraseMode = 'lyrics';
        }
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    function showAboutModal() {
        toggleNoren(false);
        document.getElementById('about-modal').style.display = 'flex';
    }
    function closeAboutModal() {
        document.getElementById('about-modal').style.display = 'none';
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function toggleNoren(open) {
        const menu = document.getElementById('noren-menu');
        const overlay = document.getElementById('noren-overlay');
        const isOpen = open !== undefined ? open : !menu.classList.contains('open');
        menu.classList.toggle('open', isOpen);
        overlay.style.display = isOpen ? 'block' : 'none';
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `flex flex-col ${type === 'user' ? 'items-end' : 'items-start'} relative mb-4`;
        div.innerHTML = type === 'user' 
            ? `<div class="bubble user bg-orange-500 shadow-sm">${text}</div>`
            : `<img src="https://unavatar.io/twitter/noki_dochibi" class="bot-icon"><div class="bubble bot shadow-sm">${text}</div>`;
        document.getElementById('music-chat-container').appendChild(div);
        div.scrollIntoView({ behavior: 'smooth' });
    }

    function addLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = "flex items-start relative mb-4";
        div.innerHTML = `<img src="https://unavatar.io/twitter/noki_dochibi" class="bot-icon"><div class="bubble bot pulse-text">å—ä¿¡ä¸­...</div>`;
        document.getElementById('music-chat-container').appendChild(div);
        return id;
    }
    function removeLoading(id) { document.getElementById(id)?.remove(); }

    function getLabelClass(name) {
        if (name.includes('Pop')) return 'pop';
        if (name.includes('Rock')) return 'rock';
        if (name.includes('Aloha')) return 'aloha';
        return 'other';
    }
    function getLabelText(name) {
        if (name.includes('Pop')) return 'POP';
        if (name.includes('Rock')) return 'ROCK';
        if (name.includes('Aloha')) return 'ALOHA';
        return 'OTHER';
    }

    function setupEventListeners() {
        document.getElementById('music-form').addEventListener('submit', handlePhraseSearch);
        document.getElementById('live-search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.liveRecords.filter(r => r.tourName.toLowerCase().includes(term) || r.venue.toLowerCase().includes(term));
            renderLiveList(filtered);
        });
    }

    function populateFilters() {
        const years = [...new Set(allData.liveRecords.map(r => r.year))].sort((a,b) => b-a);
        const select = document.getElementById('year-select');
        if (!select) return;
        years.forEach(y => select.innerHTML += `<option value="${y}">${y}å¹´</option>`);
    }
</script>
</body>
</html>
