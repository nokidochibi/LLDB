<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Love Like DataBase Unified</title>
<meta name="theme-color" content="#ef4444">

<!-- „Ç¢„Ç§„Ç≥„É≥„Éª„Éû„Éã„Éï„Çß„Çπ„Éà -->
<link id="app-icon" rel="icon" type="image/png" href="icon_live.png">
<link id="apple-touch-icon" rel="apple-touch-icon" href="icon_live.png">
<link id="manifest-link" rel="manifest" href='data:application/manifest+json,{"name":"Love Like DataBase","short_name":"LLDB","start_url":".","display":"standalone","background_color":"#F8F8F8","theme_color":"#ef4444","icons":[{"src":"icon_live.png","sizes":"192x192 512x512","type":"image/png"}]}'>

<!-- „É©„Ç§„Éñ„É©„É™ -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
    :root { 
        --app-music: #f97316; --app-live: #ef4444; --app-history: #ec4899; --app-stats: #0f172a;
        --bg-color: #F8F8F8; --card-shadow: 0 2px 5px rgba(0,0,0,0.08);
        --aiko-pink: #FF69B4; --aiko-red: #ef4444; --aiko-yellow: #FFD700; --aiko-blue: #00BFFF;
    }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", sans-serif;
        background-color: var(--bg-color); color: #374151; 
        min-height: 100vh; overflow: hidden; touch-action: pan-y pinch-zoom; -webkit-tap-highlight-color: transparent;
    }

    /* „Ç¢„Éó„É™ÁîªÈù¢Âü∫Êú¨Ë®≠ÂÆö */
    .app-screen { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: white; display: none; flex-direction: column; 
        overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
        padding-top: 60px; padding-bottom: calc(70px + env(safe-area-inset-bottom));
    }
    .app-screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    /* „Éò„ÉÉ„ÉÄ„Éº„Éª„É°„Éã„É•„Éº */
    header { height: 60px; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.3s; }
    #noren-menu {
        position: fixed; top: 60px; left: 0; width: 100%;
        background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); z-index: 90;
        transform: translateY(-120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    }
    #noren-menu.open { transform: translateY(0); }
    #noren-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 80; display: none; }

    /* ÂêÑ„Ç¢„Éó„É™Âõ∫Êúâ„ÅÆ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Ôºà‰∏ãÈÉ®Ôºâ */
    .bottom-nav { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: white; border-top: 1px solid #eee; 
        display: none; height: calc(64px + env(safe-area-inset-bottom));
        padding-bottom: env(safe-area-inset-bottom); z-index: 50;
    }
    .bottom-nav.active { display: flex; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: #9CA3AF; font-size: 10px; font-weight: bold; cursor: pointer; }
    .nav-item.active { color: var(--active-color, #ef4444); }

    /* Ë©≥Á¥∞„Éì„É•„Éº */
    #live-detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 110; overflow-y: auto; padding-top: 60px; display: none; animation: slideIn 0.2s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* ÂÖ±ÈÄöUI„Éë„Éº„ÉÑ */
    .card-base { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 12px; }
    .bubble { border-radius: 1.2rem; padding: 12px 16px; max-width: 85%; font-size: 14px; margin-bottom: 12px; position: relative; line-height: 1.6; }
    .bubble.bot { background: white; border: 1px solid #e5e7eb; border-top-left-radius: 4px; margin-left: 44px; }
    .bubble.user { background: var(--app-music); color: white; border-top-right-radius: 4px; align-self: flex-end; margin-left: auto; }
    .bot-icon { width: 36px; height: 36px; border-radius: 50%; position: absolute; left: 0; top: 0; border: 1px solid #eee; }

    /* LLDB live Âõ∫Êúâ„Çπ„Çø„Ç§„É´ */
    .live-card-label { position: absolute; top: 12px; right: 12px; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 99px; color: white; }
    .live-card-label.pop { background: var(--aiko-pink); }
    .live-card-label.rock { background: var(--aiko-blue); }
    .live-card-label.aloha { background: var(--aiko-yellow); color: #333; }
    
    /* ËªåË∑°„Ç∞„É™„ÉÉ„Éâ */
    .history-row { display: grid; grid-template-columns: 48px 1fr 1fr 1fr; border-bottom: 1px dashed #eee; min-height: 44px; }
    .history-row.year-start { border-top: 2px solid #ddd; }
    .col-date { font-size: 10px; color: #999; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; background: #fafafa; border-right: 1px solid #eee; }
    .event-chip { font-size: 9px; font-weight: bold; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; text-align: center; }
    .event-chip.live { background: white; color: #ef4444; border: 1px solid #ef4444; }
    .event-chip.single { background: #e0f2fe; color: #0284c7; }
    .event-chip.album { background: #fef9c3; color: #854d0e; }

    /* ÊöóÈªí„É¢„Éº„ÉâÔºà„Åó„Çä„Å®„ÇäÁî®Ôºâ */
    body.dark-mode { background: #0f172a; color: #e2e8f0; }
    body.dark-mode .app-screen { background: #0f172a; }
    body.dark-mode header, body.dark-mode .bottom-nav { background: #1e293b; border-color: #334155; }
    body.dark-mode .bubble.bot { background: #334155; border-color: #475569; color: white; }

    /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .pulse-text { animation: pulse 1.5s infinite; }
    @keyframes pulse { 50% { opacity: .5; } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="theme-live">

<!-- ÊöñÁ∞æ„É°„Éã„É•„Éº -->
<div id="noren-overlay" onclick="toggleNoren()"></div>
<div id="noren-menu">
    <div class="flex flex-col p-2">
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('music')">
            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="music"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB phrase</div><div class="text-xs text-gray-400">Ê≠åË©û / Ê•ΩÊõ≤Ê§úÁ¥¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('live')">
            <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="mic-2"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB live</div><div class="text-xs text-gray-400">„É©„Ç§„Éñ / „Çª„Éà„É™Ê§úÁ¥¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <!-- ‰ªñ„ÅÆ„É°„Éã„É•„Éº„ÇÇÂêåÊßò„Å´ÈÖçÁΩÆ -->
    </div>
</div>

<!-- „Éò„ÉÉ„ÉÄ„Éº -->
<header id="main-header" class="bg-red-500 text-white transition-colors duration-300">
    <div class="flex items-center gap-2">
        <button id="header-back-btn" class="hidden p-1" onclick="closeLiveDetail()"><i data-lucide="arrow-left"></i></button>
        <h1 class="font-bold text-lg" id="header-title" ondblclick="activateSecretMode()">LLDB live</h1>
    </div>
    <button onclick="toggleNoren()" class="p-2"><i data-lucide="menu"></i></button>
</header>

<!-- ============================================
     1. LLDB phrase (Music App)
     ============================================ -->
<div id="app-music" class="app-screen">
    <div id="music-chat-container" class="flex-1 p-4 overflow-y-auto bg-orange-50/30">
        <!-- „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ -->
    </div>
    <!-- phraseÁî®„Çø„Éñ -->
    <div class="flex w-full bg-white border-t border-gray-100 sticky bottom-0">
        <button onclick="switchPhraseTab('lyrics')" id="phrase-tab-lyrics" class="flex-1 py-3 text-sm font-bold text-orange-500 border-t-2 border-orange-500">Ê≠åË©û</button>
        <button onclick="switchPhraseTab('title')" id="phrase-tab-title" class="flex-1 py-3 text-sm font-bold text-gray-400">Ê•ΩÊõ≤</button>
    </div>
    <!-- ÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
    <div class="p-3 bg-white border-t border-gray-100">
        <form id="music-form" class="flex gap-2">
            <input type="text" id="music-input" placeholder="„Éï„É¨„Éº„Ç∫„ÇíÂÖ•Âäõ" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none">
            <button type="submit" class="bg-orange-500 text-white p-2 rounded-full"><i data-lucide="send" class="w-5 h-5"></i></button>
        </form>
    </div>
</div>

<!-- ============================================
     2. LLDB live (Live App)
     ============================================ -->
<div id="app-live" class="app-screen">
    <!-- ÂêÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÂÖ¨Êºî„ÄÅÊ•ΩÊõ≤„ÄÅÂ†¥ÊâÄ„ÄÅÂÇæÂêë„ÄÅËªåË∑°Ôºâ„ÇíÂàá„ÇäÊõø„Åà„Çã -->
    <div id="live-content-container" class="p-4">
        <!-- Ê§úÁ¥¢„Éª„É™„Çπ„Éà„Ç®„É™„Ç¢ -->
        <div id="live-tab-search" class="live-sub-content">
            <div class="card-base bg-gray-50 border border-gray-200 mb-4">
                <input type="text" id="live-search-input" placeholder="„É©„Ç§„ÉñÂêç„Éª‰ºöÂ†¥„ÉªÂπ¥„ÅßÊ§úÁ¥¢" class="w-full bg-white border rounded p-2 text-sm mb-2">
                <div class="flex gap-2">
                    <select id="tour-select" class="flex-1 text-xs p-1 border rounded"><option value="">„Åô„Åπ„Å¶„ÅÆ„É©„Ç§„Éñ</option></select>
                    <select id="year-select" class="flex-1 text-xs p-1 border rounded"><option value="">„Åô„Åπ„Å¶„ÅÆÂπ¥</option></select>
                </div>
            </div>
            <div id="live-list" class="space-y-3"></div>
        </div>

        <!-- ËªåË∑°„Çø„Éñ -->
        <div id="live-tab-history" class="live-sub-content hidden">
            <div id="history-grid" class="history-grid-container bg-white"></div>
        </div>
        
        <!-- ‰ªñ„ÅÆ„Çµ„Éñ„Çø„ÉñÔºàÊ•ΩÊõ≤„ÄÅÂ†¥ÊâÄ„ÄÅÂÇæÂêëÔºâ„ÇÇÂêåÊßò„Å´ÂÆüË£Ö -->
    </div>
</div>

<!-- „É©„Ç§„ÉñË©≥Á¥∞„Éì„É•„Éº -->
<div id="live-detail-view">
    <div class="p-4">
        <div class="card-base border-l-4 border-pink-500">
            <p id="detail-date" class="text-xs text-gray-400"></p>
            <h2 id="detail-title" class="font-bold text-xl text-red-500"></h2>
            <p id="detail-venue" class="text-sm font-bold"></p>
        </div>
        <h3 class="font-bold mb-2">üéµ „Çª„ÉÉ„Éà„É™„Çπ„Éà</h3>
        <div id="detail-setlist" class="card-base"></div>
    </div>
</div>

<!-- ‰∏ãÈÉ®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ (Live AppÁî®) -->
<nav id="live-nav" class="bottom-nav">
    <div class="nav-item active" onclick="switchLiveTab('search')"><i data-lucide="calendar-days"></i><span>ÂÖ¨Êºî</span></div>
    <div class="nav-item" onclick="switchLiveTab('song')"><i data-lucide="music"></i><span>Ê•ΩÊõ≤</span></div>
    <div class="nav-item" onclick="switchLiveTab('venue')"><i data-lucide="map-pin"></i><span>Â†¥ÊâÄ</span></div>
    <div class="nav-item" onclick="switchLiveTab('history')"><i data-lucide="footprints"></i><span>ËªåË∑°</span></div>
</nav>

<script>
    // --- ‚òÖÂÆöÊï∞„ÉªÁä∂ÊÖãÁÆ°ÁêÜ‚òÖ ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
    const VERSION = "v5.0.0";
    let allData = { liveRecords: [], songData: {}, historyData: [] };
    let currentApp = 'live';
    let currentPhraseMode = 'lyrics';
    let isDarkMode = false;

    // --- ÂàùÊúüÂåñ ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        loadData();
        switchApp('live');
        setupEventListeners();
    });

    async function loadData() {
        try {
            const response = await fetch(`${GAS_API_URL}?action=getAllData`);
            const data = await response.json();
            if (data.status === 'success') {
                allData = data;
                renderLiveList(allData.liveRecords);
                renderHistory();
                populateFilters();
            }
        } catch (e) { console.error("Data load failed", e); }
    }

    // --- „Ç¢„Éó„É™Âàá„ÇäÊõø„Åà (ÊöñÁ∞æ) ---
    function switchApp(appName) {
        currentApp = appName;
        document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`app-${appName}`).classList.add('active');
        
        // „Éò„ÉÉ„ÉÄ„Éº„Éª„ÉÜ„Éº„ÉûÂà∂Âæ°
        const header = document.getElementById('main-header');
        const title = document.getElementById('header-title');
        const nav = document.getElementById('live-nav');
        
        if (appName === 'live') {
            header.className = "bg-red-500 text-white";
            title.textContent = "LLDB live";
            nav.classList.add('active');
            document.documentElement.style.setProperty('--active-color', '#ef4444');
        } else if (appName === 'music') {
            header.className = "bg-orange-500 text-white";
            title.textContent = "LLDB phrase";
            nav.classList.remove('active');
            document.documentElement.style.setProperty('--active-color', '#f97316');
        }
        
        toggleNoren(false);
    }

    // --- LLDB live „É≠„Ç∏„ÉÉ„ÇØ ---
    function switchLiveTab(tabName) {
        document.querySelectorAll('.live-sub-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`live-tab-${tabName}`).classList.remove('hidden');
        document.querySelectorAll('#live-nav .nav-item').forEach(i => i.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function renderLiveList(records) {
        const container = document.getElementById('live-list');
        container.innerHTML = records.sort((a,b) => new Date(b.date) - new Date(a.date)).map(rec => `
            <div class="card-base relative overflow-hidden" onclick="openLiveDetail('${rec.date}', '${rec.tourName.replace(/'/g, "\\'")}')">
                <div class="live-card-label ${getLabelClass(rec.tourName)}">${getLabelText(rec.tourName)}</div>
                <p class="text-xs text-gray-400">${rec.date} (${rec.dayOfWeek})</p>
                <p class="font-bold text-gray-800 leading-tight pr-12">${rec.tourName}</p>
                <p class="text-xs text-gray-500 mt-1">${rec.venue}</p>
            </div>
        `).join('');
    }

    function openLiveDetail(date, tourName) {
        const rec = allData.liveRecords.find(r => r.date === date && r.tourName === tourName);
        if (!rec) return;
        document.getElementById('detail-date').textContent = rec.date;
        document.getElementById('detail-title').textContent = rec.tourName;
        document.getElementById('detail-venue').textContent = rec.venue;
        
        let html = '';
        let num = 1;
        rec.setlist.forEach(s => {
            if (s === '__MEDLEY_START__') { html += `<div class="font-bold text-yellow-600 mt-2">„É°„Éâ„É¨„Éº</div>`; return; }
            if (s === '__MEDLEY_END__') return;
            html += `<div class="py-1 border-b border-gray-50 text-sm flex gap-2"><span class="text-gray-300 w-6">${num++}.</span>${s.replace(/_„Ç¢„É≥„Ç≥„Éº„É´/g, '')}</div>`;
        });
        document.getElementById('detail-setlist').innerHTML = html;
        document.getElementById('live-detail-view').style.display = 'block';
        document.getElementById('header-back-btn').classList.remove('hidden');
    }

    function closeLiveDetail() {
        document.getElementById('live-detail-view').style.display = 'none';
        document.getElementById('header-back-btn').classList.add('hidden');
    }

    function renderHistory() {
        const container = document.getElementById('history-grid');
        let html = '';
        let lastYear = '';
        allData.historyData.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(ev => {
            const year = ev.date.split('/')[0];
            const month = ev.date.split('/')[1];
            const rowClass = (year !== lastYear) ? 'year-start' : '';
            html += `
                <div class="history-row ${rowClass}">
                    <div class="col-date">${year !== lastYear ? `<span class="font-bold text-gray-800">${year}</span>` : ''} ${month}Êúà</div>
                    <div class="p-1">${ev.type === 'live' ? `<div class="event-chip live">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'single' ? `<div class="event-chip single">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'album' ? `<div class="event-chip album">${ev.title}</div>` : ''}</div>
                </div>
            `;
            lastYear = year;
        });
        container.innerHTML = html;
    }

    // --- LLDB phrase „É≠„Ç∏„ÉÉ„ÇØ ---
    async function handlePhraseSearch(e) {
        e.preventDefault();
        const query = document.getElementById('music-input').value.trim();
        if (!query) return;
        
        addMessage(query, 'user');
        document.getElementById('music-input').value = '';
        const loadingId = addLoading();

        const endpoint = currentPhraseMode === 'lyrics' ? 'searchLyrics' : 'searchTitleData';
        try {
            const res = await fetch(`${GAS_API_URL}?action=${endpoint}&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            removeLoading(loadingId);
            
            if (currentPhraseMode === 'lyrics') renderLyricsResults(data);
            else renderTitleResults(data);
        } catch (e) { addMessage("„Ç®„É©„Éº„ÅåËµ∑„Åç„Åü„Åø„Åü„ÅÑ...", "bot"); }
    }

    function activateSecretMode() {
        if (currentApp !== 'music') return;
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        if (isDarkMode) {
            addMessage("Ë£è„É¢„Éº„Éâ„Äå„Åó„Çä„Å®„Çä„ÄçËµ∑Âãï„ÄÇÊõ≤Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠„ÄÇ", "bot");
            currentPhraseMode = 'shiritori';
        } else {
            currentPhraseMode = 'lyrics';
        }
    }

    // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
    function toggleNoren(open) {
        const menu = document.getElementById('noren-menu');
        const overlay = document.getElementById('noren-overlay');
        const isOpen = open !== undefined ? open : !menu.classList.contains('open');
        menu.classList.toggle('open', isOpen);
        overlay.style.display = isOpen ? 'block' : 'none';
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `flex flex-col ${type === 'user' ? 'items-end' : 'items-start'} relative mb-4`;
        div.innerHTML = type === 'user' 
            ? `<div class="bubble user bg-orange-500 shadow-sm">${text}</div>`
            : `<img src="https://unavatar.io/twitter/noki_dochibi" class="bot-icon"><div class="bubble bot shadow-sm">${text}</div>`;
        document.getElementById('music-chat-container').appendChild(div);
        div.scrollIntoView({ behavior: 'smooth' });
    }

    function addLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = "flex items-start relative mb-4";
        div.innerHTML = `<img src="https://unavatar.io/twitter/noki_dochibi" class="bot-icon"><div class="bubble bot pulse-text">Âèó‰ø°‰∏≠...</div>`;
        document.getElementById('music-chat-container').appendChild(div);
        return id;
    }
    function removeLoading(id) { document.getElementById(id)?.remove(); }

    function getLabelClass(name) {
        if (name.includes('Pop')) return 'pop';
        if (name.includes('Rock')) return 'rock';
        if (name.includes('Aloha')) return 'aloha';
        return 'other';
    }
    function getLabelText(name) {
        if (name.includes('Pop')) return 'POP';
        if (name.includes('Rock')) return 'ROCK';
        if (name.includes('Aloha')) return 'ALOHA';
        return 'OTHER';
    }

    function setupEventListeners() {
        document.getElementById('music-form').addEventListener('submit', handlePhraseSearch);
        // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
        document.getElementById('live-search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.liveRecords.filter(r => r.tourName.toLowerCase().includes(term) || r.venue.toLowerCase().includes(term));
            renderLiveList(filtered);
        });
    }

    function populateFilters() {
        const years = [...new Set(allData.liveRecords.map(r => r.year))].sort((a,b) => b-a);
        const select = document.getElementById('year-select');
        years.forEach(y => select.innerHTML += `<option value="${y}">${y}Âπ¥</option>`);
    }
</script>
</body>
</html>
