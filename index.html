<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Love Like DataBase Unified</title>
<meta name="theme-color" content="#ef4444">

<!-- ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
<link id="app-icon" rel="icon" type="image/png" href="icon_live.png">
<link id="apple-touch-icon" rel="apple-touch-icon" href="icon_live.png">
<link id="manifest-link" rel="manifest" href='data:application/manifest+json,{"name":"Love Like DataBase","short_name":"LLDB","start_url":".","display":"standalone","background_color":"#F8F8F8","theme_color":"#ef4444","icons":[{"src":"icon_live.png","sizes":"192x192 512x512","type":"image/png"}]}'>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
    :root { 
        --app-music: #f97316; --app-live: #ef4444; --app-history: #ec4899; --app-stats: #0f172a;
        --bg-color: #F8F8F8; --card-shadow: 0 2px 5px rgba(0,0,0,0.08);
        --aiko-pink: #FF69B4; --aiko-red: #ef4444; --aiko-yellow: #FFD700; --aiko-blue: #00BFFF;
        --bubble-color: #f97316;
    }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        background-color: var(--bg-color); color: #374151; 
        min-height: 100vh; overflow: hidden; touch-action: pan-y pinch-zoom; -webkit-tap-highlight-color: transparent;
        transition: background-color 0.3s, color 0.3s;
    }

    /* ã‚¢ãƒ—ãƒªç”»é¢åŸºæœ¬è¨­å®š */
    .app-screen { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: white; display: none; flex-direction: column; 
        overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
        padding-top: 60px; padding-bottom: calc(140px + env(safe-area-inset-bottom));
    }
    .app-screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    header { height: 60px; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.3s; }
    #noren-menu {
        position: fixed; top: 60px; left: 0; width: 100%;
        background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); z-index: 90;
        transform: translateY(-120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    }
    #noren-menu.open { transform: translateY(0); }
    #noren-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 80; display: none; }

    /* å„ã‚¢ãƒ—ãƒªå›ºæœ‰ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ */
    .bottom-nav { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: white; border-top: 1px solid #eee; 
        display: none; height: calc(64px + env(safe-area-inset-bottom));
        padding-bottom: env(safe-area-inset-bottom); z-index: 50;
    }
    .bottom-nav.active { display: flex; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: #9CA3AF; font-size: 10px; font-weight: bold; cursor: pointer; }
    .nav-item.active { color: var(--active-color, #ef4444); }

    /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ */
    #live-detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 110; overflow-y: auto; padding-top: 60px; display: none; animation: slideIn 0.2s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* å…±é€šUIãƒ‘ãƒ¼ãƒ„ */
    .card-base { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 12px; }
    
    /* å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .bubble { position: relative; border-radius: 1.2rem; transition: background-color 0.3s, color 0.3s; padding: 12px 16px; font-size: 14px; line-height: 1.6; max-width: 85%; margin-bottom: 12px; }
    .bubble-left { background: white; border: 1px solid #e5e7eb; margin-left: 44px; }
    .bubble-left::before {
        content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
        border-style: solid; border-width: 6px 10px 6px 0;
        border-color: transparent #ffffff transparent transparent;
    }
    .bubble-right { background: var(--bubble-color, #f97316); color: white; margin-left: auto; }
    .bubble-right::before {
        content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
        border-style: solid; border-width: 6px 0 6px 10px;
        border-color: transparent transparent transparent var(--bubble-color, #f97316);
    }
    .bot-icon { width: 36px; height: 36px; border-radius: 50%; position: absolute; left: 0; top: 0; border: 1px solid #eee; background: white; }

    /* phraseã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .phrase-tab-btn { border-top-width: 3px; border-color: transparent; transition: all 0.3s; opacity: 0.5; color: #9ca3af; font-weight: bold; }
    .phrase-tab-btn.active { opacity: 1; background: #f9fafb; border-color: var(--active-color, #f97316); color: var(--active-color, #f97316); }

    /* æš—é»’ãƒ¢ãƒ¼ãƒ‰ (ã—ã‚Šã¨ã‚Šç”¨) */
    body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
    body.dark-mode .app-screen { background-color: #0f172a; }
    body.dark-mode header, body.dark-mode .bottom-nav, body.dark-mode #phrase-footer-content { background-color: #1e293b; border-color: #334155; }
    body.dark-mode .bubble-left { background-color: #334155; border-color: #475569; color: #f1f5f9; }
    body.dark-mode .bubble-left::before { border-right-color: #334155; }
    body.dark-mode .phrase-tab-btn.active { background-color: #334155; }
    body.dark-mode input { color: white; }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .pulse-text { animation: pulse 1.5s infinite; }
    @keyframes pulse { 50% { opacity: .5; } }
    .highlight-text { color: #ea580c; font-weight: bold; background-color: #fff7ed; padding: 0 2px; border-radius: 2px; }
    .message-row { scroll-margin-top: 80px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-content { background: white; border-radius: 20px; padding: 24px; width: 90%; max-width: 400px; position: relative; animation: modalIn 0.3s ease-out; }
    @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body class="theme-live">

<!-- æš–ç°¾ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="noren-overlay" onclick="toggleNoren()"></div>
<div id="noren-menu">
    <div class="flex flex-col p-2">
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('music')">
            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="music"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB phrase</div><div class="text-xs text-gray-400">æ­Œè© / æ¥½æ›²æ¤œç´¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('live')">
            <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="mic-2"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB live</div><div class="text-xs text-gray-400">ãƒ©ã‚¤ãƒ– / ã‚»ãƒˆãƒªæ¤œç´¢</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('history')">
            <div class="w-10 h-10 bg-pink-500 rounded-xl flex items-center justify-center text-white"><i data-lucide="heart-handshake"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB history</div><div class="text-xs text-gray-400">aikoã¨è‡ªåˆ† / å¹´è¡¨</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4 border-b border-gray-100" onclick="switchApp('stats')">
            <div class="w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center text-white"><i data-lucide="bar-chart-2"></i></div>
            <div class="flex-1"><div class="font-bold">LLDB stats</div><div class="text-xs text-gray-400">äººæ°—ã®aiko / çµ±è¨ˆ</div></div>
            <i data-lucide="chevron-right" class="text-gray-300"></i>
        </div>
        <div class="flex items-center gap-4 p-4" onclick="showAboutModal()">
            <div class="w-10 h-10 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500"><i data-lucide="info"></i></div>
            <div class="flex-1"><div class="font-bold">About</div><div class="text-xs text-gray-400">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div></div>
        </div>
    </div>
    <div class="py-2 flex justify-center cursor-pointer" onclick="toggleNoren()">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
    </div>
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header id="main-header" class="bg-red-500 text-white transition-colors duration-300">
    <div class="flex items-center gap-2">
        <button id="header-back-btn" class="hidden p-1" onclick="closeLiveDetail()"><i data-lucide="arrow-left"></i></button>
        <h1 class="font-bold text-lg cursor-pointer select-none active:scale-95 transition-transform" id="header-title" ondblclick="activateSecretMode()">LLDB live</h1>
    </div>
    <div class="flex items-center gap-1">
        <span id="header-version-display" class="text-[10px] font-mono opacity-60 bg-white/20 px-1.5 py-0.5 rounded"></span>
        <button onclick="toggleNoren()" class="p-2"><i data-lucide="menu"></i></button>
    </div>
</header>

<!-- ============================================
     1. LLDB phrase (Music App)
     ============================================ -->
<div id="app-music" class="app-screen">
    <div id="chat-container-lyrics" class="flex-1 p-4 overflow-y-auto bg-orange-50/30 space-y-4 no-scrollbar">
        <div class="flex items-start relative mb-4">
            <img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi">
            <div class="bubble bubble-left shadow-sm">èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼ğŸŒ·</div>
        </div>
    </div>
    <div id="chat-container-title" class="flex-1 p-4 overflow-y-auto bg-sky-50/30 space-y-4 no-scrollbar hidden">
        <div class="flex items-start relative mb-4">
            <img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi">
            <div class="bubble bubble-left shadow-sm">æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚„åéŒ²æ›²é †ã‚’æ•™ãˆã‚‹ã‚ˆğŸ’¿</div>
        </div>
    </div>
    <div id="chat-container-shiritori" class="flex-1 p-4 overflow-y-auto bg-pink-50/30 space-y-4 no-scrollbar hidden">
        <div class="flex items-start relative mb-4">
            <img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi">
            <div class="bubble bubble-left shadow-sm">ã•ãã€ã—ã‚Šã¨ã‚Šã®æ™‚é–“ã ã€‚<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã¿ã‚ˆã€‚ï¼ˆä¾‹ï¼šèŠ±ç«ï¼‰</div>
        </div>
    </div>

    <!-- phraseç”¨ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
    <div id="phrase-footer-content" class="fixed bottom-0 left-0 w-full z-40 bg-white border-t border-gray-100 safe-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="music-form" class="flex items-center gap-2 px-3 py-3 border-b border-gray-50">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2.5 transition-colors focus-within:bg-white border border-transparent focus-within:border-gray-200">
                <input type="text" id="music-input" class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400" placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" autocomplete="off">
            </div>
            <button type="submit" class="bg-orange-500 text-white p-2.5 rounded-full shadow-sm active:scale-95 transition" id="music-submit-btn">
                <i data-lucide="send" class="w-5 h-5 fill-current"></i>
            </button>
        </form>
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
        <div id="phrase-tabs" class="flex w-full">
            <button onclick="switchPhraseTab('lyrics')" id="phrase-tab-lyrics" class="phrase-tab-btn active flex-1 py-3 text-center flex flex-col items-center gap-1">
                <i data-lucide="music" class="w-5 h-5"></i><span class="text-[10px]">æ­Œè©</span>
            </button>
            <div class="w-[1px] bg-gray-100 my-2"></div>
            <button onclick="switchPhraseTab('title')" id="phrase-tab-title" class="phrase-tab-btn flex-1 py-3 text-center flex flex-col items-center gap-1">
                <i data-lucide="disc" class="w-5 h-5"></i><span class="text-[10px]">æ¥½æ›²</span>
            </button>
        </div>
    </div>
</div>

<!-- ============================================
     2. LLDB live (Live App)
     ============================================ -->
<div id="app-live" class="app-screen">
    <div id="live-content-container" class="p-4">
        <div id="live-tab-search" class="live-sub-content">
            <div class="card-base bg-gray-50 border border-gray-200 mb-4">
                <input type="text" id="live-search-input" placeholder="ãƒ©ã‚¤ãƒ–åãƒ»ä¼šå ´ãƒ»å¹´ã§æ¤œç´¢" class="w-full bg-white border rounded p-2 text-sm mb-2 focus:outline-none focus:border-red-400">
                <div class="flex gap-2">
                    <select id="tour-select" class="flex-1 text-xs p-1 border rounded bg-white"><option value="">ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–</option></select>
                    <select id="year-select" class="flex-1 text-xs p-1 border rounded bg-white"><option value="">ã™ã¹ã¦ã®å¹´</option></select>
                </div>
            </div>
            <div id="live-list" class="space-y-3"></div>
        </div>
        <div id="live-tab-history" class="live-sub-content hidden">
            <div id="history-grid" class="history-grid-container bg-white"></div>
        </div>
    </div>
</div>

<!-- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»é¢ -->
<div id="app-history" class="app-screen"><div class="flex-1 flex flex-col items-center justify-center p-8 text-center"><i data-lucide="heart-handshake" class="w-12 h-12 text-pink-300 mb-4"></i><h2 class="text-2xl font-bold text-pink-600 mb-2">Coming Soon?</h2><p class="text-gray-400 text-sm">aikoã¨ã‚ãªãŸã®æ­´å²ã‚’é‡ã­ã‚‹æ©Ÿèƒ½ã‚’æº–å‚™ä¸­ã§ã™ğŸŒ·</p></div></div>
<div id="app-stats" class="app-screen"><div class="flex-1 flex flex-col items-center justify-center p-8 text-center"><i data-lucide="bar-chart-2" class="w-12 h-12 text-slate-300 mb-4"></i><h2 class="text-2xl font-bold text-slate-700 mb-2">Coming Soon?</h2><p class="text-gray-400 text-sm">YouTubeã®å†ç”Ÿæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã®çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆä¸­ã§ã™ğŸ“ˆ</p></div></div>

<!-- ãƒ©ã‚¤ãƒ–è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
<div id="live-detail-view">
    <div class="p-4">
        <div class="card-base border-l-4 border-pink-500">
            <p id="detail-date" class="text-xs text-gray-400"></p>
            <h2 id="detail-title" class="font-bold text-xl text-red-500"></h2>
            <p id="detail-venue" class="text-sm font-bold"></p>
        </div>
        <h3 class="font-bold mb-2">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
        <div id="detail-setlist" class="card-base no-scrollbar"></div>
    </div>
</div>

<!-- About ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="about-modal" class="modal-overlay" onclick="closeAboutModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-lg">About App</h2>
            <button onclick="closeAboutModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-500 mx-auto mb-3"><i data-lucide="heart" class="w-8 h-8 fill-current"></i></div>
            <p class="font-bold text-gray-800">Love Like DataBase</p>
            <p id="about-version-display" class="text-[10px] text-gray-400"></p>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600 leading-relaxed mb-6">ã“ã®ã‚¢ãƒ—ãƒªã¯ï¼‘aikoãƒ•ã‚¡ãƒ³ã«ã‚ˆã‚‹éå…¬å¼ãªã‚¢ãƒ—ãƒªã§ã™ã€‚aikoã•ã‚“ã®æ¥½æ›²ã‚„ãƒ©ã‚¤ãƒ–ã®æ­´å²ã‚’ã€æ¥½ã—ã¿ãªãŒã‚‰æ¤œç´¢ã§ãã‚‹ã‚ˆã†åˆ¶ä½œã—ã¦ã„ã¾ã™ã€‚</div>
        <div class="flex items-center justify-between text-xs border-t border-gray-100 pt-4">
            <span class="text-gray-400">Developed by <span class="font-bold text-gray-600">ã®ãğŸŒ³</span></span>
            <a href="https://twitter.com/noki_dochibi" target="_blank" class="text-blue-400 font-bold hover:underline">@noki_dochibi</a>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity pointer-events-none z-[300]">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

<!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (Live Appç”¨) -->
<nav id="live-nav" class="bottom-nav">
    <div class="nav-item active" onclick="switchLiveTab('search')"><i data-lucide="calendar-days"></i><span>å…¬æ¼”</span></div>
    <div class="nav-item" onclick="switchLiveTab('song')"><i data-lucide="music"></i><span>æ¥½æ›²</span></div>
    <div class="nav-item" onclick="switchLiveTab('venue')"><i data-lucide="map-pin"></i><span>å ´æ‰€</span></div>
    <div class="nav-item" onclick="switchLiveTab('history')"><i data-lucide="footprints"></i><span>è»Œè·¡</span></div>
</nav>

<script>
    // --- â˜…å®šæ•°ãƒ»çŠ¶æ…‹ç®¡ç†â˜… ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
    const VERSION = "v5.1.3";
    const LOADING_MESSAGES = {
        lyrics: ["aikoã‹ã‚‰ã®telepathyã‚’å—ä¿¡ä¸­...", "ãã‚“ãªã“ã¨ã‚ˆã‚Šãƒ‘ãƒ¼ãƒ†ã‚£æŠœã‘å‡ºã•ãªã„ï¼Ÿ"],
        title: ["ãŠã£ï¼ãã®æ›²ãªã‚‰ç¢ºã‹ã­...", "ä¿ºã‚‚ãã‚Œå¥½ãã ã‚ˆï¼å¾…ã£ã¦ã¦..."],
        shiritori: ["ä¿ºã«å‹è² ã‚’ä»•æ›ã‘ã‚‹ã¨ã¯ã„ã„åº¦èƒ¸ã ã€‚", "ãªã‚‹ã»ã©ã€ãã†æ¥ãŸã‹..."]
    };

    let allData = { liveRecords: [], songData: {}, historyData: [] };
    let currentApp = 'live';
    let phraseMode = 'lyrics';
    let lastPhraseMode = 'lyrics';
    let isDarkMode = false;

    // --- åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        document.getElementById('header-version-display').textContent = VERSION;
        document.getElementById('about-version-display').textContent = `Unified Version ${VERSION}`;
        loadData();
        switchApp('live');
        setupEventListeners();
    });

    async function loadData() {
        try {
            const response = await fetch(`${GAS_API_URL}?action=getAllData`);
            const data = await response.json();
            if (data.status === 'success') {
                allData = data;
                renderLiveList(allData.liveRecords);
                renderHistory();
                populateFilters();
            }
        } catch (e) { console.error("Data load failed", e); }
    }

    // --- ã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆ (æš–ç°¾) ---
    function switchApp(appName) {
        currentApp = appName;
        document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(`app-${appName}`);
        if (target) target.classList.add('active');
        
        const header = document.getElementById('main-header');
        const title = document.getElementById('header-title');
        const nav = document.getElementById('live-nav');
        
        nav.classList.remove('active');
        document.body.classList.remove('dark-mode');

        if (appName === 'live') {
            header.className = "bg-red-500 text-white";
            title.textContent = "LLDB live";
            nav.classList.add('active');
            document.documentElement.style.setProperty('--active-color', '#ef4444');
        } else if (appName === 'music') {
            header.className = "bg-orange-500 text-white";
            title.textContent = "LLDB phrase";
            document.documentElement.style.setProperty('--active-color', '#f97316');
            switchPhraseTab(phraseMode);
        } else if (appName === 'history') {
            header.className = "bg-pink-500 text-white"; title.textContent = "LLDB history";
        } else if (appName === 'stats') {
            header.className = "bg-slate-900 text-white"; title.textContent = "LLDB stats";
        }
        toggleNoren(false);
    }

    // --- LLDB phrase ãƒ­ã‚¸ãƒƒã‚¯ ---
    function switchPhraseTab(mode) {
        phraseMode = mode;
        const containers = {
            'lyrics': document.getElementById('chat-container-lyrics'),
            'title': document.getElementById('chat-container-title'),
            'shiritori': document.getElementById('chat-container-shiritori')
        };
        
        Object.values(containers).forEach(c => c.classList.add('hidden'));
        containers[mode].classList.remove('hidden');

        document.querySelectorAll('.phrase-tab-btn').forEach(b => b.classList.remove('active'));
        const activeBtn = document.getElementById(`phrase-tab-${mode}`);
        if (activeBtn) activeBtn.classList.add('active');

        const submitBtn = document.getElementById('music-submit-btn');
        const input = document.getElementById('music-input');

        if (mode === 'lyrics') {
            document.documentElement.style.setProperty('--bubble-color', '#f97316');
            submitBtn.className = "bg-orange-500 text-white p-2.5 rounded-full shadow-sm active:scale-95 transition";
            input.placeholder = "ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«";
        } else if (mode === 'title') {
            document.documentElement.style.setProperty('--bubble-color', '#0ea5e9');
            submitBtn.className = "bg-sky-500 text-white p-2.5 rounded-full shadow-sm active:scale-95 transition";
            input.placeholder = "ä¾‹ï¼šãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«";
        } else if (mode === 'shiritori') {
            document.documentElement.style.setProperty('--bubble-color', '#ec4899');
            submitBtn.className = "bg-pink-500 text-white p-2.5 rounded-full shadow-sm active:scale-95 transition";
            input.placeholder = "æ›²åã‚’å…¥åŠ›ã—ã¦ã­";
        }
        lucide.createIcons();
    }

    async function handleMusicSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('music-input');
        const query = input.value.trim();
        if (!query) return;

        addMusicMessage(query, 'user');
        input.value = '';
        const loadingId = addMusicLoading();

        try {
            const endpoint = (phraseMode === 'lyrics') ? 'searchLyrics' : (phraseMode === 'title' ? 'searchTitleData' : 'shiritori');
            const response = await fetch(`${GAS_API_URL}?action=${endpoint}&q=${encodeURIComponent(query)}&mode=${phraseMode}`);
            const data = await response.json();
            removeMusicLoading(loadingId);

            if (data.status === 'success') {
                if (phraseMode === 'lyrics') renderLyricsResults(data);
                else if (phraseMode === 'title') renderTitleResults(data);
                else renderShiritoriResults(data);
            } else {
                addMusicMessage("ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... ã´ãˆã‚“", 'bot');
            }
        } catch (e) {
            removeMusicLoading(loadingId);
            addMusicMessage("é€šä¿¡ã«å¤±æ•—ã—ãŸã‚ˆã€‚ã‚‚ã†ä¸€å›ã‚„ã£ã¦ã¿ã¦ï¼", 'bot');
        }
    }

    function addMusicMessage(content, type) {
        const container = document.getElementById(`chat-container-${phraseMode}`);
        const div = document.createElement('div');
        div.className = `flex items-start message-row relative mb-4 animate-fade-in ${type === 'user' ? 'justify-end' : ''}`;
        
        if (type === 'user') {
            div.innerHTML = `<div class="bubble bubble-right shadow-sm">${content}</div>`;
        } else {
            div.innerHTML = `<img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi"><div class="bubble bubble-left shadow-sm">${content}</div>`;
        }
        container.appendChild(div);
        div.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function addMusicLoading() {
        const container = document.getElementById(`chat-container-${phraseMode}`);
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = "flex items-start relative mb-4";
        const msgs = LOADING_MESSAGES[phraseMode] || ["ãƒ†ãƒ¬ãƒ‘ã‚·ãƒ¼å—ä¿¡ä¸­..."];
        const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
        div.innerHTML = `<img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi"><div class="bubble bubble-left shadow-sm"><p class="text-sm pulse-text">${randomMsg}</p></div>`;
        container.appendChild(div);
        div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        return id;
    }

    function removeMusicLoading(id) { document.getElementById(id)?.remove(); }

    function renderLyricsResults(data) {
        if (!data.results || data.results.length === 0) {
            addMusicMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­Œè©ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è¡¨è¨˜ã«ã—ã¦ã¿ã¦ï¼`, 'bot');
            return;
        }

        let html = '<div class="flex flex-col gap-2">';
        if (data.fuzzy_type) {
            html += `<div class="bg-orange-100/50 border border-orange-200 rounded-lg p-2 text-[10px] text-orange-700">ã€Œ${data.query}ã€ã®ã‹ã‚ã‚Šã«ã€Œ${data.actual_query}ã€ã§è¦‹ã¤ã‘ãŸã‚ˆï¼</div>`;
        }

        const highlightWord = data.fuzzy_type ? data.actual_query : data.query;
        data.results.forEach(item => {
            const highlighted = item.phrase.replace(new RegExp(`(${highlightWord})`, 'gi'), '<span class="highlight-text">$1</span>');
            html += `<div class="py-2 border-b border-orange-50 cursor-pointer" onclick="copyToClipboard('${item.phrase.replace(/'/g, "\\'")}ï¼ˆ${item.title}ï¼‰')">
                        <p class="text-sm text-gray-700">${highlighted} <span class="text-[10px] text-gray-400">ï¼ˆ${item.title}ï¼‰</span></p>
                     </div>`;
        });
        
        const uniqueCount = new Set(data.results.map(r => r.title)).size;
        const allText = data.results.map(item => `${item.phrase}ï¼ˆ${item.title}ï¼‰`).join('\n').replace(/'/g, "\\'");

        html += `<div class="mt-3 pt-2 border-t border-dashed border-orange-100">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <p class="text-[10px] text-gray-400 font-bold">${uniqueCount}æ›²ä¸­ã€è¨ˆ${data.results.length}ç®‡æ‰€è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª</p>
                        <button onclick="copyToClipboard('${allText}')" class="text-[10px] text-orange-500 bg-orange-50 px-2 py-1 rounded-full border border-orange-200 flex items-center gap-1 shadow-sm"><i data-lucide="copy" class="w-3 h-3"></i> ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
                    </div>
                 </div>`;
        html += `<div class="flex justify-center mt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 transition">ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
        html += '</div>';
        addMusicMessage(html, 'bot');
        lucide.createIcons();
    }

    function renderTitleResults(data) {
        if (!data.songs || data.songs.length === 0) {
            addMusicMessage("ãã®æ›²ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­£å¼åç§°ã§æ¢ã—ã¦ã¿ã¦ï¼", 'bot');
            return;
        }
        let html = '<div class="flex flex-col gap-4">';
        data.songs.forEach(song => {
            html += `<div class="bg-sky-50/50 rounded-lg p-3 border border-sky-100">
                        <div class="font-bold text-sky-700">${song.title} <span class="text-[10px] font-normal text-gray-400">(${song.reading})</span></div>
                        <div class="text-[11px] text-gray-600 mt-2 space-y-1">
                            ${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-400">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ æœªåéŒ²</p>'}
                            <p>ğŸ¼ ç·¨æ›²: ${song.arranger || 'ä¸æ˜'}</p>
                            ${song.age_at_release ? `<p class="text-sky-600 font-bold">ãƒªãƒªãƒ¼ã‚¹å½“æ™‚ã®aikoã¯${song.age_at_release}æ­³ï¼</p>` : ''}
                        </div>
                     </div>`;
        });
        html += `<div class="flex justify-center mt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-sky-300 hover:text-sky-500 transition">ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
        html += '</div>';
        addMusicMessage(html, 'bot');
    }

    function renderShiritoriResults(data) {
        if (data.result === 'unknown_song') { addMusicMessage(data.message, 'bot'); return; }
        if (data.result === 'user_lose' || data.result === 'user_win') {
            addMusicMessage(`${data.message}<br><div class="flex gap-2 mt-3"><button onclick="restartShiritori()" class="flex-1 bg-pink-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm">ã‚‚ã†ä¸€åº¦éŠã¶</button><button onclick="activateSecretMode()" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm">ãŠã—ã¾ã„ã«ã™ã‚‹</button></div>`, 'bot');
            return;
        }
        let html = `<p>${data.message}</p>`;
        if (data.hints && data.hints.length > 0) {
            const hintId = 'hint-' + Date.now();
            html += `<div class="mt-2">
                        <button onclick="document.getElementById('${hintId}').classList.toggle('hidden')" class="text-[10px] font-bold text-pink-500 flex items-center gap-1"><i data-lucide="lightbulb" class="w-3 h-3"></i> ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
                        <div id="${hintId}" class="hidden mt-2 flex flex-wrap gap-2 animate-fade-in">`;
            data.hints.forEach(h => {
                html += `<button onclick="sendShiritoriAnswer('${h.title}')" class="bg-white border border-pink-200 text-pink-500 px-3 py-1 rounded-full text-[10px] font-bold shadow-sm">${h.title}</button>`;
            });
            html += `</div></div>`;
        }
        addMusicMessage(html, 'bot');
        lucide.createIcons();
    }

    function sendShiritoriAnswer(text) {
        document.getElementById('music-input').value = text;
        document.getElementById('music-form').dispatchEvent(new Event('submit'));
    }
    function restartShiritori() {
        document.getElementById('chat-container-shiritori').innerHTML = `<div class="flex items-start relative mb-4 animate-fade-in"><img class="bot-icon shadow-sm" src="https://unavatar.io/twitter/noki_dochibi"><div class="bubble bubble-left shadow-sm">ã—ã‚Šã¨ã‚Šãƒªã‚»ãƒƒãƒˆï¼<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚</div></div>`;
    }

    function activateSecretMode() {
        if (currentApp !== 'music') return;
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        const footerArea = document.getElementById('phrase-tabs');
        if (isDarkMode) {
            lastPhraseMode = phraseMode;
            addMusicMessage("è£ãƒ¢ãƒ¼ãƒ‰ã€Œã—ã‚Šã¨ã‚Šã€èµ·å‹•ã€‚æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚", "bot");
            switchPhraseTab('shiritori');
            footerArea.classList.add('hidden');
        } else {
            switchPhraseTab(lastPhraseMode);
            footerArea.classList.remove('hidden');
        }
    }

    // --- LLDB live ãƒ­ã‚¸ãƒƒã‚¯ ---
    function switchLiveTab(tabName) {
        document.querySelectorAll('.live-sub-content').forEach(c => c.classList.add('hidden'));
        const target = document.getElementById(`live-tab-${tabName}`);
        if (target) target.classList.remove('hidden');
        document.querySelectorAll('#live-nav .nav-item').forEach(i => i.classList.remove('active'));
        if (event && event.currentTarget) event.currentTarget.classList.add('active');
    }

    function renderLiveList(records) {
        const container = document.getElementById('live-list');
        if (!container) return;
        container.innerHTML = records.sort((a,b) => new Date(b.date) - new Date(a.date)).map(rec => `
            <div class="card-base relative overflow-hidden" onclick="openLiveDetail('${rec.date}', '${rec.tourName.replace(/'/g, "\\'")}')">
                <div class="live-card-label ${getLabelClass(rec.tourName)}">${getLabelText(rec.tourName)}</div>
                <p class="text-xs text-gray-400">${rec.date} (${rec.dayOfWeek})</p>
                <p class="font-bold text-gray-800 leading-tight pr-12">${rec.tourName}</p>
                <p class="text-xs text-gray-500 mt-1">${rec.venue}</p>
            </div>
        `).join('');
    }

    function openLiveDetail(date, tourName) {
        const rec = allData.liveRecords.find(r => r.date === date && r.tourName === tourName);
        if (!rec) return;
        document.getElementById('detail-date').textContent = rec.date;
        document.getElementById('detail-title').textContent = rec.tourName;
        document.getElementById('detail-venue').textContent = rec.venue;
        let html = '', num = 1;
        rec.setlist.forEach(s => {
            if (s === '__MEDLEY_START__') { html += `<div class="font-bold text-yellow-600 mt-2 text-sm">ãƒ¡ãƒ‰ãƒ¬ãƒ¼</div>`; return; }
            if (s === '__MEDLEY_END__') return;
            html += `<div class="py-1 border-b border-gray-50 text-xs flex gap-2"><span class="text-gray-300 w-6">${num++}.</span>${s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '')}</div>`;
        });
        document.getElementById('detail-setlist').innerHTML = html;
        document.getElementById('live-detail-view').style.display = 'block';
        document.getElementById('header-back-btn').classList.remove('hidden');
    }

    function closeLiveDetail() {
        document.getElementById('live-detail-view').style.display = 'none';
        document.getElementById('header-back-btn').classList.add('hidden');
    }

    function renderHistory() {
        const container = document.getElementById('history-grid');
        if (!container) return;
        let html = '', lastYear = '';
        allData.historyData.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(ev => {
            const parts = ev.date.split('/'), year = parts[0], month = parts[1];
            const rowClass = (year !== lastYear) ? 'year-start' : '';
            html += `
                <div class="history-row ${rowClass}">
                    <div class="col-date">${year !== lastYear ? `<span class="font-bold text-gray-800">${year}</span>` : ''} ${month}æœˆ</div>
                    <div class="p-1">${ev.type === 'live' ? `<div class="event-chip live">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'single' ? `<div class="event-chip single">${ev.title}</div>` : ''}</div>
                    <div class="p-1">${ev.type === 'album' ? `<div class="event-chip album">${ev.title}</div>` : ''}</div>
                </div>
            `;
            lastYear = year;
        });
        container.innerHTML = html;
    }

    // --- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function toggleNoren(open) {
        const menu = document.getElementById('noren-menu'), overlay = document.getElementById('noren-overlay');
        const isOpen = open !== undefined ? open : !menu.classList.contains('open');
        menu.classList.toggle('open', isOpen);
        overlay.style.display = isOpen ? 'block' : 'none';
    }
    function showAboutModal() { toggleNoren(false); document.getElementById('about-modal').style.display = 'flex'; }
    function closeAboutModal() { document.getElementById('about-modal').style.display = 'none'; }
    function showToast() { const t = document.getElementById('toast'); t.classList.remove('opacity-0'); setTimeout(() => t.classList.add('opacity-0'), 2000); }
    function copyToClipboard(text) {
        if (navigator.clipboard) { navigator.clipboard.writeText(text).then(showToast); }
        else { const a = document.createElement('textarea'); a.value = text; document.body.appendChild(a); a.select(); document.execCommand('copy'); document.body.removeChild(a); showToast(); }
    }
    function getLabelClass(n) { if (n.includes('Pop')) return 'pop'; if (n.includes('Rock')) return 'rock'; if (n.includes('Aloha')) return 'aloha'; return 'other'; }
    function getLabelText(n) { if (n.includes('Pop')) return 'POP'; if (n.includes('Rock')) return 'ROCK'; if (n.includes('Aloha')) return 'ALOHA'; return 'OTHER'; }

    function setupEventListeners() {
        document.getElementById('music-form').addEventListener('submit', handleMusicSubmit);
        document.getElementById('live-search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.liveRecords.filter(r => r.tourName.toLowerCase().includes(term) || r.venue.toLowerCase().includes(term));
            renderLiveList(filtered);
        });
    }

    function populateFilters() {
        const years = [...new Set(allData.liveRecords.map(r => r.year))].sort((a,b) => b-a);
        const select = document.getElementById('year-select');
        if (select) years.forEach(y => select.innerHTML += `<option value="${y}">${y}å¹´</option>`);
    }
</script>
</body>
</html>
