<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLDB history v0.3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #fdf2f8; /* Pink-50 */
            color: #374151;
            padding-top: 0px;
            /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ–ã®åˆ†ã ã‘ä¸‹ã‚’ç©ºã‘ã‚‹ */
            padding-bottom: calc(64px + env(safe-area-inset-bottom));
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-base {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #fce7f3; /* Pink-100 */
        }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        select {
            font-size: 15px !important;
            padding: 10px 12px !important;
            border-radius: 8px !important;
            border: 1px solid #fbcfe8 !important; /* Pink-200 */
            background-color: #fff !important;
            width: 100%;
            color: #db2777; /* Pink-600 */
            font-weight: bold;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th {
            position: sticky;
            top: 0;
            background-color: #ec4899; /* Pink-500 */
            color: white;
            font-size: 12px;
            padding: 8px 4px;
            z-index: 20; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šæ‰‹å‰ã« */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .history-table td {
            padding: 8px 4px;
            border-bottom: 1px solid #fbcfe8; /* Pink-200 */
            vertical-align: middle;
            font-size: 12px;
            height: 40px; /* è¡Œã®é«˜ã•ã‚’ç¢ºä¿ */
        }
        .history-table tr:nth-child(even) { background-color: #fff1f2; } /* Pink-50 */
        
        /* ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒ« */
        .lifestage-cell {
            font-size: 10px;
            color: #be185d; /* Pink-700 */
            font-weight: bold;
            line-height: 1.2;
            background-color: #fce7f3;
            border-radius: 4px;
            padding: 2px 4px;
            display: inline-block;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– */
        nav {
            padding-bottom: env(safe-area-inset-bottom);
            position: fixed !important;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex !important;
            border-top: 1px solid #fce7f3;
            height: calc(64px + env(safe-area-inset-bottom));
            z-index: 50;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #9ca3af; /* Gray-400 */
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-item.active {
            color: #ec4899; /* Pink-500 */
            background-color: #fdf2f8;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <main class="w-full max-w-lg mx-auto">
        
        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="input-area" class="card-base m-4">
            <div class="flex items-end gap-2">
                <div class="flex-1">
                    <label class="block text-[10px] font-bold text-pink-400 mb-1">ç”Ÿå¹´æœˆæ—¥</label>
                    <div class="flex gap-2">
                        <select id="year" class="flex-[3]"></select>
                        <select id="month" class="flex-[2]"></select>
                        <select id="day" class="flex-[2]"></select>
                    </div>
                </div>
                <button onclick="generateHistory()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold p-3 rounded-lg shadow-sm transition-transform active:scale-95 flex-shrink-0 mb-[1px]">
                    <i data-lucide="check" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div id="content-area" class="hidden fade-in">
            
            <!-- Tab: å¹´è¡¨ -->
            <!-- é«˜ã•åˆ¶é™ã‚’æ’¤å»ƒã—ã€ç”»é¢å…¨ä½“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ -->
            <div id="view-history" class="bg-white shadow-sm border-t border-b border-pink-100 min-h-screen">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">å¹´æœˆ</th>
                            <th style="width: 10%;">å¹´é½¢</th>
                            <th style="width: 20%;">ãƒ©ã‚¤ãƒ•<br>ã‚¹ãƒ†ãƒ¼ã‚¸</th>
                            <th style="width: 55%;">aiko Release</th>
                        </tr>
                    </thead>
                    <tbody id="timeline-body">
                        <!-- JS Generated -->
                    </tbody>
                </table>
                
                <!-- æœ€å¾Œã®ä½™ç™½ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼è¢«ã‚Šé˜²æ­¢ã®å¿µæŠ¼ã—ï¼‰ -->
                <div class="h-20"></div>
            </div>

            <!-- Tab: ä»Šæ—¥ã®è‡ªåˆ† -->
            <div id="view-today" class="hidden p-4">
                 <!-- aiko Days -->
                 <div class="bg-white rounded-2xl shadow-sm p-6 mb-4 border border-pink-100 text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="clock" class="w-24 h-24 text-pink-500"></i>
                    </div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">aikoã¨éã”ã—ãŸæ™‚é–“</h3>
                    <div class="text-4xl font-extrabold text-pink-600 mb-1">
                        <span id="days-with-aiko">0</span>
                        <span class="text-base font-normal text-pink-400 ml-1">Days</span>
                    </div>
                    <p class="text-xs text-gray-400" id="days-detail">ã‚ãªãŸãŒç”Ÿã¾ã‚Œã¦ã‹ã‚‰...</p>
                </div>

                <!-- aiko Ratio -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-4 border border-pink-100 flex items-center justify-between relative overflow-hidden">
                     <div class="absolute bottom-0 left-0 p-4 opacity-10">
                        <i data-lucide="percent" class="w-20 h-20 text-pink-500"></i>
                    </div>
                    <div class="z-10 text-left">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">äººç”Ÿã«ãŠã‘ã‚‹aikoç‡</h3>
                        <div class="text-5xl font-extrabold text-pink-500">
                            <span id="aiko-ratio">0</span><span class="text-2xl">%</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">äººç”Ÿã®ã»ã¨ã‚“ã©ãŒaikoã¨å…±ã«ï¼</p>
                    </div>
                    <div class="w-24 h-24 rounded-full bg-pink-100 border-4 border-pink-200 flex items-center justify-center relative z-10">
                        <i data-lucide="heart" class="w-10 h-10 text-pink-400 fill-pink-400 animate-pulse"></i>
                    </div>
                </div>

                <!-- Age Sync -->
                <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl shadow-md p-6 text-white relative">
                    <h3 class="text-xs font-bold text-pink-100 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="calendar-clock" class="w-4 h-4"></i> TIME TRAVEL
                    </h3>
                    <div class="text-center mb-4">
                        <p class="text-sm text-pink-100">ã‚‚ã—ã€ã‚ãªãŸãŒaikoã ã£ãŸã‚‰...</p>
                        <p class="text-lg font-bold mt-1">ä»Šã®ã‚ãªãŸã¨åŒã˜<span id="sync-age-highlight" class="text-yellow-300 text-xl mx-1">--æ­³</span>ã®é ƒ</p>
                        <p class="text-xs text-pink-200 mt-1">aikoã¯ <span id="sync-date-display">----å¹´--æœˆ</span> ã«ã“ã®æ›²ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã„ã¾ã—ãŸ</p>
                    </div>
                    <div id="pickup-container" class="text-center mt-6">
                        <div id="pickup-image-area" class="bg-white/20 w-32 h-32 mx-auto rounded-lg mb-4 flex items-center justify-center backdrop-blur-sm overflow-hidden shadow-inner">
                            <i data-lucide="disc" class="w-16 h-16 text-white/80"></i>
                        </div>
                        <h4 class="text-xl font-bold mb-2 leading-tight" id="pickup-title">Loading...</h4>
                    </div>
                </div>
            </div>

        </div>

        <div id="loading" class="hidden text-center py-12">
            <div class="animate-spin text-pink-400 mb-2 text-2xl">â³</div>
            <p class="text-sm text-gray-400 animate-pulse">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav>
        <div onclick="switchTab('history')" class="tab-item active" data-tab="history">
            <i data-lucide="scroll" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">å¹´è¡¨</span>
        </div>
        <div onclick="switchTab('today')" class="tab-item" data-tab="today">
            <i data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">ä»Šæ—¥ã®è‡ªåˆ†</span>
        </div>
    </nav>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
        const AIKO_DEBUT = new Date(1998, 6, 17);
        const AIKO_BIRTH = new Date(1975, 10, 22);

        let allData = null;
        let birthDate = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            populateDates();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª•ç”Ÿæ—¥ã‚’å¾©å…ƒ
            const savedBirth = localStorage.getItem('lldb_user_birth');
            if (savedBirth) {
                const [y, m, d] = savedBirth.split('-');
                document.getElementById('year').value = y;
                document.getElementById('month').value = parseInt(m);
                document.getElementById('day').value = parseInt(d);
            }
        });

        function populateDates() {
            const yEl = document.getElementById('year'), mEl = document.getElementById('month'), dEl = document.getElementById('day');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 1950; i--) yEl.add(new Option(i, i, false, i === 1998));
            for (let i = 1; i <= 12; i++) mEl.add(new Option(i, i, false, i === 7));
            for (let i = 1; i <= 31; i++) dEl.add(new Option(i, i, false, i === 17));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-item').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tabName);
            });
            document.getElementById('view-history').classList.toggle('hidden', tabName !== 'history');
            document.getElementById('view-today').classList.toggle('hidden', tabName !== 'today');
            
            if (tabName === 'today' && allData && birthDate) {
                renderTodayStats();
            }
            lucide.createIcons();
        }

        async function generateHistory() {
            const y = document.getElementById('year').value;
            const m = document.getElementById('month').value;
            const d = document.getElementById('day').value;
            birthDate = new Date(y, m - 1, d);
            
            // ä¿å­˜
            localStorage.setItem('lldb_user_birth', `${y}-${m}-${d}`);

            document.getElementById('input-area').classList.add('hidden'); // å…¥åŠ›å¾Œã¯éš ã™
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content-area').classList.add('hidden');

            // ãƒ‡ãƒ¼ã‚¿æœªå–å¾—ãªã‚‰å–å¾—
            if (!allData) {
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                    const cache = localStorage.getItem('lldb_data_v3_9_fix7');
                    if (cache) {
                        try {
                            const parsed = JSON.parse(cache);
                            if (parsed.liveRecords) {
                                allData = parsed;
                            }
                        } catch(e) {}
                    }

                    if (!allData) {
                        const res = await fetch(`${GAS_API_URL}?action=getAllData`);
                        const json = await res.json();
                        allData = json;
                    }
                } catch (e) {
                    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }
            }

            renderTimeline();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');
            switchTab('history');
        }

        // æ—¥ä»˜æ–‡å­—åˆ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function parseDateFromInfo(infoStr) {
            if (!infoStr) return null;
            // "yyyy/MM/dd ç™ºå£²ã®..." å½¢å¼ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º
            const match = infoStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
            if (match) {
                return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            }
            return null;
        }

        function renderTimeline() {
            const tbody = document.getElementById('timeline-body');
            tbody.innerHTML = '';

            // ãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
            // 1. å¹´è¡¨ã®é–‹å§‹çµ‚äº†ï¼ˆèª•ç”Ÿæ—¥ã€œç¾åœ¨ï¼‰
            const startYear = birthDate.getFullYear();
            const startMonth = birthDate.getMonth();
            const now = new Date();
            const endYear = now.getFullYear();
            const endMonth = now.getMonth();

            // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¹´æœˆã‚­ãƒ¼ã§æ•´ç†
            const eventsMap = {}; // "YYYY-M": []

            // Live Data
            if (allData.liveRecords) {
                allData.liveRecords.forEach(rec => {
                    const d = new Date(rec.date);
                    const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                    if (!eventsMap[key]) eventsMap[key] = [];
                    
                    // Fåˆ—ç›¸å½“(shortTourName) or tourName
                    const tourName = rec.shortTourName || rec.tourName;
                    
                    // é‡è¤‡æ’é™¤: åŒã˜ã‚­ãƒ¼ã®ä¸­ã«æ—¢ã«åŒã˜ãƒ„ã‚¢ãƒ¼åãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
                    const exists = eventsMap[key].some(e => e.type === 'live' && e.name === tourName);
                    if (!exists) {
                        eventsMap[key].push({ type: 'live', name: tourName, date: d });
                    }
                });
            }

            // Song Data (Single/Album)
            if (allData.songData) {
                const releases = new Set();
                Object.values(allData.songData).forEach(song => {
                     // ã‚¢ãƒ«ãƒãƒ æƒ…å ± (album_infoã‹ã‚‰æ—¥ä»˜æŠ½å‡º)
                     if (song.album_info) {
                         const d = parseDateFromInfo(song.album_info);
                         // songDataã«ã¯å„æ›²ã”ã¨ã«ã‚¢ãƒ«ãƒãƒ æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ã‚¢ãƒ«ãƒãƒ åã§é‡è¤‡æ’é™¤
                         const albumName = song.albumTitle || song.album_info.match(/ã‚¢ãƒ«ãƒãƒ ã€(.*?)ã€/)?.[1] || "ã‚¢ãƒ«ãƒãƒ ";
                         
                         if (d) {
                             const k = `A-${d.getFullYear()}-${d.getMonth() + 1}-${albumName}`;
                             if (!releases.has(k)) {
                                 releases.add(k);
                                 const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                                 if (!eventsMap[key]) eventsMap[key] = [];
                                 eventsMap[key].push({ type: 'album', name: albumName, date: d });
                             }
                         }
                     }
                     
                     // ã‚·ãƒ³ã‚°ãƒ«æƒ…å ± (single_infoã‹ã‚‰æ—¥ä»˜æŠ½å‡º)
                     if (song.single_info) {
                         const d = parseDateFromInfo(song.single_info);
                         // ã‚·ãƒ³ã‚°ãƒ«ã‚‚æ›²ã”ã¨ã«æƒ…å ±ãŒã‚ã‚‹ãŸã‚é‡è¤‡æ’é™¤
                         const singleName = song.singleTitle || song.single_info.match(/ã‚·ãƒ³ã‚°ãƒ«ã€(.*?)ã€/)?.[1] || song.title; // ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                         
                         if (d) {
                             const k = `S-${d.getFullYear()}-${d.getMonth() + 1}-${singleName}`;
                             if (!releases.has(k)) {
                                 releases.add(k);
                                 const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                                 if (!eventsMap[key]) eventsMap[key] = [];
                                 eventsMap[key].push({ type: 'single', name: singleName, date: d });
                             }
                         }
                     }
                });
            }

            // ãƒ«ãƒ¼ãƒ—ç”Ÿæˆ (å…¨æœŸé–“)
            let current = new Date(startYear, startMonth, 1);
            const end = new Date(endYear, endMonth, 1);

            while (current <= end) {
                const y = current.getFullYear();
                const m = current.getMonth() + 1;
                const key = `${y}-${m}`;
                
                // å¹´é½¢è¨ˆç®—
                let age = y - birthDate.getFullYear();
                if (m < (birthDate.getMonth() + 1)) age--;

                // ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š
                let lifeStage = '';
                if (age === 6 && m === 4) lifeStage = 'å°å­¦æ ¡<br>å…¥å­¦';
                else if (age === 12 && m === 4) lifeStage = 'ä¸­å­¦æ ¡<br>å…¥å­¦';
                else if (age === 15 && m === 4) lifeStage = 'é«˜æ ¡<br>å…¥å­¦';
                else if (age === 18 && m === 4) lifeStage = 'å¤§å­¦<br>å…¥å­¦?';
                else if (age === 20 && m === 1) lifeStage = 'æˆäººå¼';
                else if (age === 22 && m === 4) lifeStage = 'ç¤¾ä¼šäºº?';
                else if (age === 0 && m === (birthDate.getMonth() + 1)) lifeStage = 'èª•ç”Ÿ';

                // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
                let eventHtml = '';
                if (eventsMap[key]) {
                    // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ
                    eventsMap[key].sort((a,b) => a.date - b.date);
                    
                    eventsMap[key].forEach(ev => {
                        if (ev.type === 'live') {
                            eventHtml += `<div class="text-[10px] text-red-500 mb-1 leading-tight"><span class="mr-0.5">ğŸ¤</span>${ev.name}</div>`;
                        } else {
                            // CD
                            eventHtml += `<div class="text-[10px] text-blue-600 mb-1 leading-tight"><span class="mr-0.5">ğŸ’¿</span>${ev.name}</div>`;
                        }
                    });
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªãã¦ã‚‚è¡Œã‚’ä½œæˆã™ã‚‹ (å…¨è¡¨ç¤º)
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center text-gray-400 font-mono">${y}<br><span class="text-xs font-bold text-gray-600">${m}æœˆ</span></td>
                    <td class="text-center font-bold text-pink-500 text-sm">${age}</td>
                    <td class="text-center">${lifeStage ? `<span class="lifestage-cell">${lifeStage}</span>` : ''}</td>
                    <td>${eventHtml}</td>
                `;
                tbody.appendChild(tr);

                current.setMonth(current.getMonth() + 1);
            }
        }

        function renderTodayStats() {
            if (!birthDate) return;
            const today = new Date();
            
            // Days
            const diffTime = Math.abs(today - birthDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let aikoDays = 0;
            if (birthDate < AIKO_DEBUT) {
                aikoDays = Math.ceil(Math.abs(today - AIKO_DEBUT) / (1000 * 60 * 60 * 24));
            } else {
                aikoDays = diffDays;
            }
            
            let ratio = (aikoDays / diffDays) * 100;
            if (ratio > 100) ratio = 100;

            document.getElementById('days-with-aiko').innerText = aikoDays.toLocaleString();
            document.getElementById('aiko-ratio').innerText = ratio.toFixed(1);

            // Sync Age (Time Travel)
            let currentAge = today.getFullYear() - birthDate.getFullYear();
            if (today.getMonth() < birthDate.getMonth() || (today.getMonth() == birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
                currentAge--;
            }
            
            const syncDateStart = new Date(AIKO_BIRTH.getFullYear() + currentAge, AIKO_BIRTH.getMonth(), AIKO_BIRTH.getDate());
            const syncDateEnd = new Date(AIKO_BIRTH.getFullYear() + currentAge + 1, AIKO_BIRTH.getMonth(), AIKO_BIRTH.getDate());
            
            document.getElementById('sync-age-highlight').innerText = `${currentAge}æ­³`;
            
            // ãã®æœŸé–“ã®ãƒªãƒªãƒ¼ã‚¹ã‚’æ¢ã™
            let found = null;
            
            if (allData.songData) {
                 const candidates = [];
                 Object.values(allData.songData).forEach(s => {
                     // single_info / album_info ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã—ã¦åˆ¤å®š
                     if (s.single_info) {
                         const d = parseDateFromInfo(s.single_info);
                         if (d && d >= syncDateStart && d < syncDateEnd) {
                             candidates.push({ name: s.singleTitle || s.single_info.match(/ã‚·ãƒ³ã‚°ãƒ«ã€(.*?)ã€/)?.[1] || s.title, date: d });
                         }
                     }
                     if (s.album_info) {
                         const d = parseDateFromInfo(s.album_info);
                         if (d && d >= syncDateStart && d < syncDateEnd) {
                             candidates.push({ name: s.albumTitle || s.album_info.match(/ã‚¢ãƒ«ãƒãƒ ã€(.*?)ã€/)?.[1], date: d });
                         }
                     }
                 });
                 
                 if (candidates.length > 0) {
                     found = candidates[Math.floor(Math.random() * candidates.length)];
                 }
            }

            if (found) {
                document.getElementById('sync-date-display').innerText = `${found.date.getFullYear()}å¹´${found.date.getMonth()+1}æœˆ`;
                document.getElementById('pickup-title').innerText = found.name;
            } else {
                document.getElementById('sync-date-display').innerText = "----å¹´--æœˆ";
                document.getElementById('pickup-title').innerText = "ã“ã®æ­³ã®ãƒªãƒªãƒ¼ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            }
        }
    </script>
</body>
</html>
